<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-Tech Network Mapping Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            /* i-Tech Brand Colors */
            --primary:#0F71F0;--secondary:#199FFF;--accent:#EF7225;
            --dark:#001543;--darker:#001E62;
            --grey:#42486A;--grey-light:#4a5080;
            --glass:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.1);
            --text:#EAEAEA;--text-secondary:#D8D7DF;--text-muted:#8a8daf;
            --green:#22c55e;--yellow:#eab308;--orange:#EF7225;--red-soft:#ef4444;
            --accent-purple:#c084fc;
            --titan-white:#D8D7DF;
            --white-smoke:#EAEAEA;
        }
        body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--dark),var(--darker));color:var(--text);overflow:hidden;height:100vh;line-height:1.6}

        /* Animated background */
        .grid-bg{position:fixed;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(15,113,240,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(15,113,240,0.03) 1px,transparent 1px);background-size:60px 60px;z-index:0;animation:gridMove 20s linear infinite;pointer-events:none}
        @keyframes gridMove{0%{transform:translate(0,0)}100%{transform:translate(60px,60px)}}
        .orb{position:fixed;border-radius:50%;filter:blur(80px);z-index:0;animation:float 20s ease-in-out infinite;pointer-events:none}
        .orb-1{width:600px;height:600px;background:radial-gradient(circle,rgba(15,113,240,0.12) 0%,transparent 70%);top:-200px;right:-200px}
        .orb-2{width:500px;height:500px;background:radial-gradient(circle,rgba(0,30,98,0.10) 0%,transparent 70%);bottom:-150px;left:-150px;animation-delay:-10s}
        .orb-3{width:400px;height:400px;background:radial-gradient(circle,rgba(25,159,255,0.08) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);animation-delay:-5s}
        @keyframes float{0%,100%{transform:translate(0,0) scale(1)}25%{transform:translate(30px,-30px) scale(1.05)}50%{transform:translate(-20px,20px) scale(0.95)}75%{transform:translate(20px,30px) scale(1.02)}}

        /* Layout */
        .app{display:grid;grid-template-columns:260px 1fr 300px;grid-template-rows:56px 1fr 40px;height:100vh;position:relative;z-index:1}

        /* Header */
        .header{grid-column:1/-1;background:rgba(0,21,67,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);display:flex;align-items:center;padding:0 1.5rem;gap:16px;z-index:100}
        .logo{font-weight:700;font-size:1.25rem;display:flex;align-items:center;gap:10px}
        .logo-icon{height:36px;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:6px;padding:4px 10px}
        .logo-icon img{height:100%;width:auto}
        .logo-tool-name{font-size:0.85rem;color:var(--text-muted);font-weight:400;margin-left:14px;padding-left:14px;border-left:1px solid var(--glass-border)}
        .client-label{display:flex;align-items:center;margin-left:20px;padding-left:20px;border-left:1px solid var(--glass-border)}
        .client-input{background:var(--glass);border:1px solid var(--glass-border);border-radius:8px;padding:6px 12px;color:var(--text);font-size:0.85rem;font-family:'Poppins',sans-serif;width:200px;outline:none;transition:border-color 0.3s}
        .client-input:focus{border-color:rgba(15,113,240,0.5)}
        .client-input::placeholder{color:var(--text-muted)}
        .header-actions{display:flex;gap:8px;margin-left:auto}

        /* Buttons */
        .btn{padding:8px 14px;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text-secondary);cursor:pointer;font-size:0.8rem;font-family:'Poppins',sans-serif;font-weight:500;display:flex;align-items:center;gap:6px;transition:all 0.3s ease;backdrop-filter:blur(10px)}
        .btn:hover{color:var(--text);border-color:rgba(15,113,240,0.4);box-shadow:0 0 15px rgba(15,113,240,0.1)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#006CFF);border-color:transparent;color:white;font-weight:600}
        .btn-primary:hover{box-shadow:0 4px 20px rgba(15,113,240,0.4);transform:translateY(-1px)}
        .btn-danger{border-color:rgba(239,68,68,0.3);color:var(--red-soft)}
        .btn-danger:hover{background:rgba(239,68,68,0.08);border-color:rgba(239,68,68,0.5);box-shadow:0 0 15px rgba(239,68,68,0.1)}

        /* Sidebar */
        .sidebar{background:rgba(0,21,67,0.9);backdrop-filter:blur(20px);border-right:1px solid var(--glass-border);overflow-y:auto;padding:14px}
        .sidebar-section{margin-bottom:20px}
        .sidebar-title{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--primary);margin-bottom:10px}
        .device-palette{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        .device-item{background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;padding:10px 8px;cursor:grab;display:flex;flex-direction:column;align-items:center;gap:6px;font-size:0.7rem;font-weight:500;color:var(--text-secondary);transition:all 0.3s ease}
        .device-item:hover{border-color:rgba(15,113,240,0.5);background:rgba(15,113,240,0.08);transform:translateY(-2px);box-shadow:0 4px 15px rgba(15,113,240,0.1)}
        .device-item .icon{font-size:20px}

        /* Canvas */
        .canvas-area{position:relative;overflow:hidden;background:#ffffff;cursor:grab}
        .canvas-area.panning{cursor:grabbing}
        .canvas-area.dragging-device{cursor:move}
        .canvas-grid{position:absolute;width:8000px;height:8000px;left:-4000px;top:-4000px;background-image:radial-gradient(circle,rgba(15,113,240,0.25) 1.5px,transparent 1.5px);background-size:20px 20px;pointer-events:none;animation:dotPulse 3s ease-in-out infinite}
        @keyframes dotPulse{0%,100%{opacity:0.6}50%{opacity:1}}
        #canvasWrapper{position:absolute;width:8000px;height:8000px;left:-4000px;top:-4000px;transform-origin:center center}
        #canvas{position:absolute;width:100%;height:100%}
        #connections{position:absolute;width:100%;height:100%;pointer-events:none;z-index:5;overflow:visible}
        .conn-wired{stroke:var(--primary);stroke-width:2;fill:none}
        .conn-wireless{stroke:var(--accent-purple);stroke-width:2;fill:none;stroke-dasharray:8,4}
        .controls{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:6px;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);padding:8px;border-radius:14px;border:1px solid #e0e0e0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,0.08)}

        /* Network devices */
        .network-device{position:absolute;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border:2px solid #e0e0e0;border-radius:14px;padding:12px;min-width:120px;cursor:move;user-select:none;z-index:10;transition:border-color 0.3s,box-shadow 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .network-device:hover{border-color:#0F71F0;box-shadow:0 4px 20px rgba(15,113,240,0.15)}
        .network-device.selected{border-color:var(--primary);box-shadow:0 0 0 3px rgba(15,113,240,0.2),0 4px 30px rgba(15,113,240,0.15)}
        .network-device.connecting{border-color:var(--green);box-shadow:0 0 0 3px rgba(34,197,94,0.15)}
        .device-status{width:8px;height:8px;border-radius:50%;position:absolute;top:10px;right:10px}
        .status-online{background:var(--green);box-shadow:0 0 8px var(--green)}
        .status-offline{background:#555}
        .status-warning{background:var(--orange);box-shadow:0 0 8px var(--orange)}
        .status-retired{background:#555;opacity:0.5}
        .status-decommissioned{background:#555}
        .device-icon{font-size:24px;margin-bottom:4px}
        .device-icon.vmhost-icon{font-size:16px;letter-spacing:-2px}
        .device-name{font-size:0.75rem;font-weight:600;margin-bottom:2px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#1a1a1a}
        .device-ip{font-size:0.65rem;color:#666;font-family:'JetBrains Mono',monospace}
        .device-badge{font-size:0.6rem;padding:3px 8px;background:rgba(15,113,240,0.1);border:1px solid rgba(15,113,240,0.2);border-radius:6px;color:#0F71F0;margin-top:6px;display:inline-block;font-weight:500}
        .conn-point{position:absolute;width:14px;height:14px;background:#ffffff;border:2px solid var(--primary);border-radius:50%;cursor:crosshair;z-index:20;opacity:0;transition:opacity 0.2s,transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
        .network-device:hover .conn-point,.network-device.connecting .conn-point{opacity:1}
        .conn-point:hover{background:var(--primary);transform:scale(1.2)}
        .conn-point.top{top:-7px;left:50%;margin-left:-7px}
        .conn-point.bottom{bottom:-7px;left:50%;margin-left:-7px}
        .conn-point.left{left:-7px;top:50%;margin-top:-7px}
        .conn-point.right{right:-7px;top:50%;margin-top:-7px}

        /* Properties panel */
        .props-panel{background:rgba(0,21,67,0.9);backdrop-filter:blur(20px);border-left:1px solid var(--glass-border);overflow-y:auto;padding:14px}
        .panel-title{font-size:0.85rem;font-weight:600;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--glass-border);background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .form-group{margin-bottom:14px}
        .form-label{display:block;font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
        .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:0.8rem;font-family:'JetBrains Mono',monospace;outline:none;transition:border-color 0.3s,box-shadow 0.3s}
        .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:rgba(15,113,240,0.5);box-shadow:0 0 0 3px rgba(15,113,240,0.1)}
        .form-textarea{min-height:60px;resize:vertical;font-family:'Poppins',sans-serif}
        .status-btns{display:flex;gap:4px;flex-wrap:wrap}
        .status-btn{flex:1;min-width:50px;padding:8px 4px;background:var(--glass);border:1px solid var(--glass-border);border-radius:10px;cursor:pointer;text-align:center;font-size:0.6rem;font-weight:500;color:var(--text-secondary);font-family:'Poppins',sans-serif;transition:all 0.3s}
        .status-btn.active{border-color:rgba(15,113,240,0.5);background:rgba(15,113,240,0.08);color:var(--text)}
        .status-btn .dot{width:8px;height:8px;border-radius:50%;margin:0 auto 4px}
        .conn-toggle{display:flex;background:rgba(0,0,0,0.3);border:1px solid var(--glass-border);border-radius:10px;padding:3px;margin-bottom:10px}
        .conn-toggle button{flex:1;padding:7px;background:none;border:none;border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:0.7rem;font-weight:500;font-family:'Poppins',sans-serif;transition:all 0.3s}
        .conn-toggle button.active{background:var(--glass);color:var(--text)}
        .conn-toggle button.wired.active{color:var(--primary)}
        .conn-toggle button.wireless.active{color:var(--accent-purple)}

        /* Status bar */
        .statusbar{grid-column:1/-1;background:rgba(0,21,67,0.9);backdrop-filter:blur(20px);border-top:1px solid var(--glass-border);display:flex;align-items:center;padding:0 1.5rem;font-size:0.7rem;font-weight:500;color:var(--text-muted);gap:20px}

        /* Modals */
        .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
        .modal-bg.active{opacity:1;visibility:visible}
        .modal{background:rgba(0,30,98,0.98);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;width:450px;max-height:80vh;overflow-y:auto;position:relative}
        .modal::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:20px 20px 0 0;opacity:0.8}
        .modal-header{padding:18px 20px;border-bottom:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center}
        .modal-header h3{font-size:0.95rem;font-weight:600;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px;transition:color 0.3s}
        .modal-close:hover{color:var(--primary)}
        .modal-body{padding:20px}
        .modal-footer{padding:14px 20px;border-top:1px solid var(--glass-border);display:flex;justify-content:flex-end;gap:8px}

        /* Config */
        .config-section{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;padding:16px;margin-bottom:12px}
        .config-title{font-size:0.75rem;font-weight:600;margin-bottom:12px;color:var(--primary)}
        .vlan-item{display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,0,0,0.3);border:1px solid var(--glass-border);border-radius:10px;font-size:0.7rem;margin-bottom:6px;transition:border-color 0.3s}
        .vlan-item:hover{border-color:rgba(255,255,255,0.15)}
        .vlan-id{font-weight:600;color:var(--secondary);min-width:60px;font-family:'JetBrains Mono',monospace}
        .vlan-subnet{color:var(--text-secondary);font-family:'JetBrains Mono',monospace}
        .vlan-name{color:var(--text-muted);flex:1}
        .vlan-del{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;transition:color 0.3s}
        .vlan-del:hover{color:var(--red-soft)}
        .add-btn{width:100%;padding:10px;background:none;border:1px dashed rgba(15,113,240,0.4);border-radius:10px;color:var(--text-muted);cursor:pointer;font-size:0.7rem;font-weight:500;font-family:'Poppins',sans-serif;transition:all 0.3s}
        .add-btn:hover{border-color:var(--primary);color:var(--primary)}

        /* VM */
        .vm-host{min-width:180px;background:rgba(255,255,255,0.95);border-style:dashed;border-color:var(--accent-purple)}
        .vm-list{margin-top:8px;padding-top:8px;border-top:1px solid #e0e0e0;display:flex;flex-wrap:wrap;gap:4px}
        .hosted-vm{background:#f5f5f5;border:1px solid #e0e0e0;border-radius:6px;padding:4px 6px;font-size:0.6rem;display:flex;align-items:center;gap:4px;color:#333}
        .hosted-vm .dot{width:6px;height:6px;border-radius:50%}

        /* Zones */
        .network-zone{position:absolute;border:2px dashed;border-radius:16px;min-width:150px;min-height:100px;z-index:1;cursor:move;user-select:none;transition:border-color 0.3s,box-shadow 0.3s}
        .network-zone:hover{box-shadow:0 4px 20px rgba(0,0,0,0.15)}
        .network-zone.selected{box-shadow:0 0 0 3px rgba(15,113,240,0.3)}
        .zone-header{padding:8px 12px;border-radius:14px 14px 0 0;display:flex;align-items:center;gap:8px;cursor:move}
        .zone-icon{font-size:18px}
        .zone-name{font-size:0.75rem;font-weight:600;color:#1a1a1a}
        .zone-badge{font-size:0.6rem;padding:2px 6px;border-radius:4px;color:white;font-weight:500}
        .zone-resize{position:absolute;bottom:0;right:0;width:20px;height:20px;cursor:se-resize;opacity:0.5;display:flex;align-items:center;justify-content:center;font-size:10px;color:#666}
        .zone-resize:hover{opacity:1}
        
        /* Zone types */
        .zone-cloud{background:rgba(96,165,250,0.08);border-color:rgba(96,165,250,0.5)}
        .zone-cloud .zone-header{background:rgba(96,165,250,0.15)}
        .zone-cloud .zone-badge{background:#3b82f6}
        
        .zone-onprem{background:rgba(139,92,246,0.08);border-color:rgba(139,92,246,0.5)}
        .zone-onprem .zone-header{background:rgba(139,92,246,0.15)}
        .zone-onprem .zone-badge{background:#8b5cf6}
        
        .zone-mdf{background:rgba(34,197,94,0.08);border-color:rgba(34,197,94,0.5)}
        .zone-mdf .zone-header{background:rgba(34,197,94,0.15)}
        .zone-mdf .zone-badge{background:#22c55e}
        
        .zone-idf{background:rgba(249,115,22,0.08);border-color:rgba(249,115,22,0.5)}
        .zone-idf .zone-header{background:rgba(249,115,22,0.15)}
        .zone-idf .zone-badge{background:#f97316}
        
        .zone-ups{background:rgba(234,179,8,0.08);border-color:rgba(234,179,8,0.5)}
        .zone-ups .zone-header{background:rgba(234,179,8,0.15)}
        .zone-ups .zone-badge{background:#eab308}
        
        .zone-item{border-style:dashed !important}

        /* Misc */
        .empty-state{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#666;pointer-events:none}
        .empty-state h3{font-size:1.1rem;font-weight:600;margin-bottom:8px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .empty-state p{font-size:0.8rem}
        .conn-hint{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--primary),#006CFF);color:white;padding:10px 20px;border-radius:12px;font-size:0.8rem;font-weight:600;z-index:1000;display:none;box-shadow:0 4px 20px rgba(15,113,240,0.4)}
        .conn-hint.active{display:block}

        /* Network info box */
        .network-info-box{position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border:1px solid #e0e0e0;border-radius:14px;padding:16px;min-width:220px;max-width:280px;z-index:100;font-size:0.7rem;box-shadow:0 2px 12px rgba(0,0,0,0.08)}
        .network-info-box h4{font-size:0.8rem;font-weight:600;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #e0e0e0;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;transition:all 0.2s ease}
        .network-info-box h4:hover{opacity:0.8;transform:translateX(2px)}
        .info-section{margin-bottom:12px}
        .info-section:last-child{margin-bottom:0}
        .info-section-title{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--primary);margin-bottom:6px}
        .info-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
        .info-label{color:#666}
        .info-value{font-family:'JetBrains Mono',monospace;color:#1a1a1a;font-weight:500}
        .vlan-tag{display:inline-block;padding:3px 8px;background:rgba(15,113,240,0.08);border:1px solid rgba(15,113,240,0.2);border-radius:6px;margin:2px;font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:#0F71F0}
        .vlan-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
        .pan-hint{position:absolute;bottom:60px;left:16px;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border:1px solid #e0e0e0;padding:8px 12px;border-radius:10px;font-size:0.65rem;color:#666;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.08)}

        /* Scrollbar */
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:var(--grey-light);border-radius:3px}
        ::-webkit-scrollbar-thumb:hover{background:rgba(15,113,240,0.4)}
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <img src="i-Tech Support Logo - small.jpg" alt="i-tech logo" />
                </div>
                <span class="logo-tool-name">Network Mapping Tool</span>
            </div>
            <div class="client-label">
                <span style="color:var(--text-muted);font-size:0.7rem;margin-right:6px;">Client:</span>
                <input type="text" id="clientName" class="client-input" placeholder="Enter client name...">
            </div>
            <div class="client-label">
                <span style="color:var(--text-muted);font-size:0.7rem;margin-right:6px;">Location/Site:</span>
                <input type="text" id="siteName" class="client-input" placeholder="Enter location...">
            </div>
            <div class="header-actions">
                <button class="btn" id="exportPdfBtn">&#x1F4C4; Export PDF</button>
                <button class="btn" id="exportJsonBtn">&#x1F4BE; Save Project</button>
                <button class="btn" id="importBtn">&#x1F4C2; Load Project</button>
                <button class="btn btn-danger" id="clearBtn">&#x1F5D1;&#xFE0F; Clear</button>
            </div>
        </header>
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Network Equipment</div>
                <div class="device-palette">
                    <div class="device-item" draggable="true" data-type="router"><span class="icon">&#x1F4E1;</span>Router</div>
                    <div class="device-item" draggable="true" data-type="firewall"><span class="icon">&#x1F6E1;&#xFE0F;</span>Firewall</div>
                    <div class="device-item" draggable="true" data-type="switch"><span class="icon">&#x1F500;</span>Switch</div>
                    <div class="device-item" draggable="true" data-type="ap"><span class="icon">&#x1F4F6;</span>Access Point</div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Servers &amp; Storage</div>
                <div class="device-palette">
                    <div class="device-item" draggable="true" data-type="server"><span class="icon">&#x1F5A5;&#xFE0F;</span>Server</div>
                    <div class="device-item" draggable="true" data-type="nas"><span class="icon">&#x1F4BE;</span>NAS</div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Virtualization</div>
                <div class="device-palette">
                    <div class="device-item" draggable="true" data-type="vmhost"><span class="icon">&#x1F5A5;&#xFE0F;&#x1F5A5;&#xFE0F;</span>VM Host</div>
                    <div class="device-item" draggable="true" data-type="vm"><span class="icon">&#x1F5A5;&#xFE0F;</span>VM</div>
                    <div class="device-item" draggable="true" data-type="storage"><span class="icon">&#x1F4E6;</span>Storage</div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Zones (Drag to Create)</div>
                <div class="device-palette">
                    <div class="device-item zone-item" draggable="true" data-zone="cloud"><span class="icon">&#x2601;&#xFE0F;</span>Cloud</div>
                    <div class="device-item zone-item" draggable="true" data-zone="onprem"><span class="icon">&#x1F3E2;</span>On-Prem</div>
                    <div class="device-item zone-item" draggable="true" data-zone="mdf"><span class="icon">&#x1F3DB;&#xFE0F;</span>MDF</div>
                    <div class="device-item zone-item" draggable="true" data-zone="idf"><span class="icon">&#x1F4E6;</span>IDF</div>
                    <div class="device-item zone-item" draggable="true" data-zone="ups"><span class="icon">&#x1F50B;</span>UPS</div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Endpoints</div>
                <div class="device-palette">
                    <div class="device-item" draggable="true" data-type="desktop"><span class="icon">&#x1F5A5;&#xFE0F;</span>Desktop</div>
                    <div class="device-item" draggable="true" data-type="laptop"><span class="icon">&#x1F4BB;</span>Laptop</div>
                    <div class="device-item" draggable="true" data-type="cellphone"><span class="icon">&#x1F4F1;</span>Cell Phone</div>
                    <div class="device-item" draggable="true" data-type="tablet"><span class="icon">&#x1F4F2;</span>Tablet</div>
                    <div class="device-item" draggable="true" data-type="printer"><span class="icon">&#x1F5A8;&#xFE0F;</span>Printer</div>
                    <div class="device-item" draggable="true" data-type="otherendpoint"><span class="icon">&#x2753;</span>Other</div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Other</div>
                <div class="device-palette">
                    <div class="device-item" draggable="true" data-type="phone"><span class="icon">&#x260E;&#xFE0F;</span>Desk Phone</div>
                    <div class="device-item" draggable="true" data-type="camera"><span class="icon">&#x1F4F9;</span>Security Cam</div>
                    <div class="device-item" draggable="true" data-type="iot"><span class="icon">&#x1F310;</span>IoT</div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Connection Type</div>
                <div class="conn-toggle">
                    <button class="wired active" id="wiredBtn">&#x2015; Wired</button>
                    <button class="wireless" id="wirelessBtn">&#x2505; Wireless</button>
                </div>
                <p style="font-size:0.65rem;color:var(--text-muted);">Click circles on devices to connect.</p>
            </div>
        </aside>
        <main class="canvas-area" id="canvasArea">
            <div class="canvas-grid" id="canvasGrid"></div>
            <div id="canvasWrapper">
                <svg id="connections" width="8000" height="8000"></svg>
                <div id="canvas"></div>
            </div>
            <div class="empty-state" id="emptyState">
                <h3>Start Building Your Network</h3>
                <p>Drag devices from the sidebar onto the canvas</p>
            </div>
            <div class="network-info-box" id="networkInfoBox">
                <h4 onclick="openConfig()" style="cursor:pointer;" title="Click to edit configuration">&#x2699;&#xFE0F; Network Configuration <span style="font-size:0.6rem;color:var(--text-muted);font-weight:normal;">&#x270E; click to edit</span></h4>
                <div class="info-section">
                    <div class="info-section-title">DNS</div>
                    <div class="info-row"><span class="info-label">Provider:</span><span class="info-value" id="infoDnsProvider">DNS Filter</span></div>
                    <div class="info-row"><span class="info-label">Primary:</span><span class="info-value" id="infoDnsPrimary">8.8.8.8</span></div>
                    <div class="info-row"><span class="info-label">Secondary:</span><span class="info-value" id="infoDnsSecondary">8.8.4.4</span></div>
                </div>
                <div class="info-section">
                    <div class="info-section-title">DHCP</div>
                    <div class="info-row"><span class="info-label">Managed by:</span><span class="info-value" id="infoDhcp">Router</span></div>
                </div>
                <div class="info-section">
                    <div class="info-section-title">VLANs</div>
                    <div class="vlan-tags" id="infoVlans"></div>
                </div>
                <div class="info-section">
                    <div class="info-section-title">Wireless SSIDs</div>
                    <div class="vlan-tags" id="infoSSIDs"></div>
                </div>
            </div>
            <div class="pan-hint">Drag empty space to pan &#x2022; Scroll to zoom</div>
            <div class="controls">
                <button class="btn" id="snapBtn" title="Toggle grid snapping">&#x1F9F2; Snap: On</button>
                <button class="btn" id="zoomInBtn">&#x1F50D;+</button>
                <button class="btn" id="zoomOutBtn">&#x1F50D;-</button>
                <button class="btn" id="resetBtn">&#x1F3E0; Reset View</button>
            </div>
        </main>
        <aside class="props-panel">
            <div class="panel-title">Properties</div>
            <div id="noSelect" style="text-align:center;padding:30px;color:var(--text-muted);"><p style="font-size:0.8rem;">Select a device to edit</p></div>
            <div id="deviceProps" style="display:none;">
                <div class="form-group" id="nameGroup"><label class="form-label" id="nameLabel">Device Name</label><input type="text" class="form-input" id="propName"></div>
                <div id="networkEquipSection" style="display:none;">
                    <div class="form-group"><label class="form-label">Manufacturer</label><input type="text" class="form-input" id="propNetEquipMfg" placeholder="e.g. Cisco, Ubiquiti" oninput="updateDeviceProp('manufacturer', this.value)"></div>
                    <div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="propNetEquipModel" placeholder="e.g. USW-24-POE" oninput="updateDeviceProp('model', this.value)"></div>
                </div>
                <div class="form-group" id="manufacturerGroup" style="display:none;"><label class="form-label">Manufacturer</label><select class="form-select" id="propManufacturer"></select></div>
                <div class="form-group" id="osGroup" style="display:none;"><label class="form-label">Operating System</label><select class="form-select" id="propOS"></select></div>
                <div id="routerSection" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Connection Type</label>
                        <div style="display:flex;gap:16px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.8rem;color:var(--text-secondary);">
                                <input type="radio" name="connType" id="propFiber" value="fiber" onchange="updateDeviceProp('connectionType', 'fiber')" style="accent-color:var(--primary);">
                                Fiber
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.8rem;color:var(--text-secondary);">
                                <input type="radio" name="connType" id="propCoax" value="coax" onchange="updateDeviceProp('connectionType', 'coax')" style="accent-color:var(--primary);">
                                Coax
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <div class="form-group" style="flex:1;"><label class="form-label">Download (Mbps)</label><input type="text" class="form-input" id="propDownload" placeholder="1000" oninput="updateDeviceProp('downloadSpeed', this.value)"></div>
                        <div class="form-group" style="flex:1;"><label class="form-label">Upload (Mbps)</label><input type="text" class="form-input" id="propUpload" placeholder="100" oninput="updateDeviceProp('uploadSpeed', this.value)"></div>
                    </div>
                </div>
                <div class="form-group" id="ipGroup"><label class="form-label">IP Address</label><input type="text" class="form-input" id="propIP" placeholder="192.168.1.1"></div>
                <div class="form-group" id="macGroup"><label class="form-label">MAC Address</label><input type="text" class="form-input" id="propMAC" placeholder="00:00:00:00:00:00"></div>
                <div class="form-group" id="statusGroup">
                    <label class="form-label">Status</label>
                    <div class="status-btns">
                        <div class="status-btn" data-status="online"><div class="dot status-online"></div>Online</div>
                        <div class="status-btn" data-status="offline"><div class="dot status-offline"></div>Offline</div>
                        <div class="status-btn" data-status="warning"><div class="dot status-warning"></div>Warning</div>
                        <div class="status-btn" data-status="retired"><div class="dot status-retired"></div>Retired</div>
                        <div class="status-btn" data-status="decommissioned"><div class="dot status-decommissioned"></div>Decom.</div>
                    </div>
                </div>
                <div class="form-group" id="vlanGroup"><label class="form-label">VLAN</label><select class="form-select" id="propVLAN"></select></div>
                <div id="ssidSection" style="display:none;">
                    <div class="form-label">Assigned SSIDs</div>
                    <div id="apSSIDList" style="max-height:150px;overflow-y:auto;margin-bottom:8px;"></div>
                </div>
                <div id="switchSection" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Number of Ports</label>
                        <select class="form-select" id="propSwitchPorts" onchange="updateDeviceProp('ports', this.value)">
                            <option value="">-- Select --</option>
                            <option value="5">5 Ports</option>
                            <option value="8">8 Ports</option>
                            <option value="12">12 Ports</option>
                            <option value="16">16 Ports</option>
                            <option value="24">24 Ports</option>
                            <option value="48">48 Ports</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.8rem;color:var(--text-secondary);">
                            <input type="checkbox" id="propPOE" onchange="updateDeviceProp('poe', this.checked)" style="width:16px;height:16px;accent-color:var(--primary);">
                            PoE Capable
                        </label>
                    </div>
                    <div class="form-label">Assigned VLANs</div>
                    <div id="switchVLANList" style="max-height:150px;overflow-y:auto;margin-bottom:8px;"></div>
                </div>
                <div id="firewallSection" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Number of Ports</label>
                        <select class="form-select" id="propFirewallPorts" onchange="updateDeviceProp('ports', this.value)">
                            <option value="">-- Select --</option>
                            <option value="2">2 Ports</option>
                            <option value="4">4 Ports</option>
                            <option value="6">6 Ports</option>
                            <option value="8">8 Ports</option>
                            <option value="10">10 Ports</option>
                            <option value="12">12 Ports</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="propNotes"></textarea></div>
                <div id="printerSection" style="display:none;">
                    <div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="propPrinterModel" placeholder="e.g. LaserJet Pro M404n" oninput="updateDeviceProp('model', this.value)"></div>
                </div>
                <div id="vmSection" style="display:none;">
                    <div class="form-label">Hosted VMs</div>
                    <div id="vmList"></div>
                    <button class="add-btn" id="addVMBtn" style="margin-top:8px;">+ Add VM</button>
                </div>
                <button class="btn btn-danger" style="width:100%;margin-top:16px;justify-content:center;" id="deleteBtn">&#x1F5D1;&#xFE0F; Delete Device</button>
            </div>
            <div id="zoneProps" style="display:none;">
                <div class="form-group"><label class="form-label">Zone Name</label><input type="text" class="form-input" id="propZoneName" oninput="updateZoneProp('name', this.value)"></div>
                <div id="upsPropsSection" style="display:none;">
                    <div class="form-group"><label class="form-label">UPS Manufacturer</label>
                        <select class="form-select" id="propUPSMfg" onchange="updateZoneProp('manufacturer', this.value)">
                            <option value="">-- Select --</option>
                            <option value="APC">APC</option>
                            <option value="CyberPower">CyberPower</option>
                            <option value="Eaton">Eaton</option>
                            <option value="Tripp Lite">Tripp Lite</option>
                            <option value="Vertiv/Liebert">Vertiv/Liebert</option>
                            <option value="Schneider Electric">Schneider Electric</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">UPS Model</label><input type="text" class="form-input" id="propUPSModel" placeholder="e.g. Smart-UPS 1500" oninput="updateZoneProp('model', this.value)"></div>
                    <div style="display:flex;gap:8px;">
                        <div class="form-group" style="flex:1;"><label class="form-label">Capacity (VA)</label><input type="text" class="form-input" id="propUPSCapacity" placeholder="1500" oninput="updateZoneProp('capacity', this.value)"></div>
                        <div class="form-group" style="flex:1;"><label class="form-label">Runtime (min)</label><input type="text" class="form-input" id="propUPSRuntime" placeholder="15" oninput="updateZoneProp('runtime', this.value)"></div>
                    </div>
                    <div class="form-group"><label class="form-label">IP Address</label><input type="text" class="form-input" id="propUPSIP" placeholder="192.168.1.100" oninput="updateZoneProp('ip', this.value)"></div>
                </div>
                <div id="mdfPropsSection" style="display:none;">
                    <div class="form-group"><label class="form-label">Location/Room</label><input type="text" class="form-input" id="propMDFLocation" placeholder="e.g. Server Room 1" oninput="updateZoneProp('location', this.value)"></div>
                </div>
                <div id="idfPropsSection" style="display:none;">
                    <div class="form-group"><label class="form-label">Location/Room</label><input type="text" class="form-input" id="propIDFLocation" placeholder="e.g. Floor 2 Closet" oninput="updateZoneProp('location', this.value)"></div>
                    <div class="form-group"><label class="form-label">Connected to MDF</label>
                        <select class="form-select" id="propIDFMDF" onchange="updateZoneProp('connectedMDF', this.value)"></select>
                    </div>
                </div>
                <div id="cloudPropsSection" style="display:none;">
                    <div class="form-group"><label class="form-label">Cloud Provider</label>
                        <select class="form-select" id="propCloudProvider" onchange="updateZoneProp('provider', this.value)">
                            <option value="">-- Select --</option>
                            <option value="AWS">Amazon Web Services</option>
                            <option value="Azure">Microsoft Azure</option>
                            <option value="GCP">Google Cloud Platform</option>
                            <option value="DigitalOcean">DigitalOcean</option>
                            <option value="Linode">Linode/Akamai</option>
                            <option value="Vultr">Vultr</option>
                            <option value="Oracle Cloud">Oracle Cloud</option>
                            <option value="IBM Cloud">IBM Cloud</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Region</label><input type="text" class="form-input" id="propCloudRegion" placeholder="e.g. us-east-1" oninput="updateZoneProp('region', this.value)"></div>
                </div>
                <div id="onpremPropsSection" style="display:none;">
                    <div class="form-group"><label class="form-label">Location/Building</label><input type="text" class="form-input" id="propOnPremLocation" placeholder="e.g. Main Office" oninput="updateZoneProp('location', this.value)"></div>
                </div>
                <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="propZoneNotes" oninput="updateZoneProp('notes', this.value)"></textarea></div>
                <button class="btn btn-danger" style="width:100%;margin-top:16px;justify-content:center;" id="deleteZoneBtn" onclick="deleteSelectedZone()">&#x1F5D1;&#xFE0F; Delete Zone</button>
            </div>
        </aside>
        <footer class="statusbar">
            <span id="deviceCount">0 devices</span>
            <span id="zoneCount">0 zones</span>
            <span id="connCount">0 connections</span>
            <span style="margin-left:auto;" id="zoomLevel">100%</span>
        </footer>
    </div>
    <div class="conn-hint" id="connHint">Click another device to complete connection</div>

    <div class="modal-bg" id="configModal">
        <div class="modal">
            <div class="modal-header"><h3>Network Configuration</h3><button class="modal-close" onclick="closeModal('configModal')">&times;</button></div>
            <div class="modal-body">
                <div class="config-section">
                    <div class="config-title">&#x1F310; DNS Configuration</div>
                    <div class="form-group"><label class="form-label">DNS Provider</label>
                        <select class="form-select" id="dnsProvider" onchange="updateDnsFields()">
                            <option value="DNS Filter">DNS Filter</option>
                            <option value="Cisco Umbrella">Cisco Umbrella</option>
                            <option value="Server Hosted">Server Hosted</option>
                            <option value="Cloudflare">Cloudflare</option>
                            <option value="Google DNS">Google DNS</option>
                        </select>
                    </div>
                    <div class="form-group" id="dnsServerGroup" style="display:none;"><label class="form-label">DNS Server</label><select class="form-select" id="dnsServerDevice"></select></div>
                    <div style="display:flex;gap:8px;">
                        <div class="form-group" style="flex:1;"><label class="form-label">Primary DNS</label><input type="text" class="form-input" id="dnsPrimary" value="8.8.8.8"></div>
                        <div class="form-group" style="flex:1;"><label class="form-label">Secondary DNS</label><input type="text" class="form-input" id="dnsSecondary" value="8.8.4.4"></div>
                    </div>
                </div>
                <div class="config-section">
                    <div class="config-title">&#x1F4CB; DHCP Configuration</div>
                    <div class="form-group"><label class="form-label">DHCP Server Type</label>
                        <select class="form-select" id="dhcpType" onchange="updateDhcpDevices()">
                            <option value="Router">Router</option>
                            <option value="Dedicated Server">Dedicated Server</option>
                            <option value="Firewall">Firewall</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">DHCP Device</label><select class="form-select" id="dhcpDevice"></select></div>
                </div>
                <div class="config-section">
                    <div class="config-title">&#x1F3F7;&#xFE0F; VLANs &amp; Subnets</div>
                    <div id="vlanList"></div>
                    <button class="add-btn" onclick="openModal('vlanModal')">+ Add VLAN</button>
                </div>
                <div class="config-section">
                    <div class="config-title">&#x1F4F6; Wireless Configuration</div>
                    <div id="ssidList"></div>
                    <button class="add-btn" onclick="openModal('ssidModal')">+ Add SSID</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveConfig()">Save &amp; Close</button></div>
        </div>
    </div>
    <div class="modal-bg" id="vlanModal">
        <div class="modal" style="width:350px;">
            <div class="modal-header"><h3>Add VLAN</h3><button class="modal-close" onclick="closeModal('vlanModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">VLAN ID</label><input type="number" class="form-input" id="newVlanID"></div>
                <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="newVlanName"></div>
                <div class="form-group"><label class="form-label">Subnet</label><input type="text" class="form-input" id="newVlanSubnet" placeholder="192.168.10.0/24"></div>
                <div class="form-group"><label class="form-label">Gateway</label><input type="text" class="form-input" id="newVlanGateway" placeholder="192.168.10.1"></div>
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('vlanModal')">Cancel</button><button class="btn btn-primary" onclick="saveVlan()">Add</button></div>
        </div>
    </div>
    <div class="modal-bg" id="ssidModal">
        <div class="modal" style="width:350px;">
            <div class="modal-header"><h3>Add SSID</h3><button class="modal-close" onclick="closeModal('ssidModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">SSID Name</label><input type="text" class="form-input" id="newSSIDName" placeholder="MyNetwork"></div>
                <div class="form-group"><label class="form-label">Security</label>
                    <select class="form-select" id="newSSIDSecurity">
                        <option value="WPA3-Enterprise">WPA3-Enterprise</option>
                        <option value="WPA3-Personal">WPA3-Personal</option>
                        <option value="WPA2-Enterprise">WPA2-Enterprise</option>
                        <option value="WPA2-Personal" selected>WPA2-Personal</option>
                        <option value="WPA/WPA2-Mixed">WPA/WPA2-Mixed</option>
                        <option value="Open">Open</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">VLAN</label>
                    <select class="form-select" id="newSSIDVlan"></select>
                </div>
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('ssidModal')">Cancel</button><button class="btn btn-primary" onclick="saveSSID()">Add</button></div>
        </div>
    </div>
    <div class="modal-bg" id="vmModal">
        <div class="modal" style="width:350px;">
            <div class="modal-header"><h3>Add VM</h3><button class="modal-close" onclick="closeModal('vmModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">VM Name</label><input type="text" class="form-input" id="newVMName"></div>
                <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="newVMStatus"><option value="online">Online</option><option value="offline">Offline</option><option value="warning">Warning</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('vmModal')">Cancel</button><button class="btn btn-primary" onclick="saveVM()">Add</button></div>
        </div>
    </div>
    <div class="modal-bg" id="exportModal">
        <div class="modal" style="width:400px;">
            <div class="modal-header"><h3>Export PDF</h3><button class="modal-close" onclick="closeModal('exportModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Document Title</label><input type="text" class="form-input" id="pdfTitle" value="Network Diagram"></div>
                <div class="form-group"><label class="form-label">Orientation</label>
                    <select class="form-select" id="pdfOrientation"><option value="landscape">Landscape</option><option value="portrait">Portrait</option></select>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.8rem;color:var(--text-secondary);">
                        <input type="checkbox" id="includeInventory" checked style="width:16px;height:16px;accent-color:var(--primary);">
                        Include device inventory (Notes, VLAN, MAC)
                    </label>
                </div>
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('exportModal')">Cancel</button><button class="btn btn-primary" onclick="generatePDF()">Export PDF</button></div>
        </div>
    </div>
    <script>
        const state = {
            devices: [],
            connections: [],
            zones: [],
            vlans: [
                { id: 1, name: 'Default', subnet: '192.168.1.0/24', gateway: '192.168.1.1' },
                { id: 10, name: 'Management', subnet: '192.168.10.0/24', gateway: '192.168.10.1' },
                { id: 20, name: 'Servers', subnet: '192.168.20.0/24', gateway: '192.168.20.1' }
            ],
            ssids: [],
            config: { dnsProvider: 'DNS Filter', dnsServer: '', dnsPrimary: '8.8.8.8', dnsSecondary: '8.8.4.4', dhcpType: 'Router', dhcpDevice: '' },
            selected: null,
            selectedZone: null,
            connType: 'wired',
            connecting: null,
            zoom: 1,
            panX: 0,
            panY: 0,
            counter: 0,
            zoneCounter: 0,
            exportFormat: 'pdf'
        };

        const zoneTypes = {
            cloud: { name: 'Cloud', icon: '', color: '#3b82f6' },
            onprem: { name: 'On-Prem', icon: '', color: '#8b5cf6' },
            mdf: { name: 'MDF', icon: '', color: '#22c55e' },
            idf: { name: 'IDF', icon: '', color: '#f97316' },
            ups: { name: 'UPS', icon: '', color: '#eab308' }
        };

        const types = {
            desktop: { name: 'Desktop', icon: '' }, laptop: { name: 'Laptop', icon: '' },
            cellphone: { name: 'Cell Phone', icon: '' }, tablet: { name: 'Tablet', icon: '' },
            otherendpoint: { name: 'Other Endpoint', icon: '' },
            server: { name: 'Server', icon: '' }, nas: { name: 'NAS', icon: '' },
            router: { name: 'Router', icon: '' }, switch: { name: 'Switch', icon: '' },
            firewall: { name: 'Firewall', icon: '' }, ap: { name: 'Access Point', icon: '' },
            vmhost: { name: 'VM Host', icon: '' }, vm: { name: 'VM', icon: '' },
            storage: { name: 'Storage', icon: '' }, printer: { name: 'Printer', icon: '' },
            iot: { name: 'IoT', icon: '' }, phone: { name: 'Desk Phone', icon: '' },
            camera: { name: 'Security Camera', icon: '' }
        };

        const manufacturers = {
            desktop: ['Dell', 'HP', 'Lenovo', 'Apple', 'Asus', 'Acer', 'Microsoft', 'Intel NUC', 'Custom Build', 'Other'],
            laptop: ['Dell', 'HP', 'Lenovo', 'Apple', 'Asus', 'Acer', 'Microsoft', 'Samsung', 'MSI', 'Razer', 'Framework', 'Other'],
            cellphone: ['Apple', 'Samsung', 'Google', 'OnePlus', 'Motorola', 'LG', 'Xiaomi', 'Huawei', 'Sony', 'Nokia', 'Other'],
            tablet: ['Apple', 'Samsung', 'Microsoft', 'Lenovo', 'Amazon', 'Google', 'Huawei', 'Asus', 'Other'],
            printer: ['HP', 'Canon', 'Epson', 'Brother', 'Xerox', 'Lexmark', 'Ricoh', 'Kyocera', 'Dell', 'Samsung', 'Konica Minolta', 'Other'],
            otherendpoint: ['Generic', 'Custom', 'Other'],
            server: ['Dell', 'HP/HPE', 'Lenovo', 'Supermicro', 'Cisco', 'IBM', 'Fujitsu', 'Intel', 'Custom Build', 'Other'],
            vm: ['VMware', 'Hyper-V', 'Proxmox', 'KVM', 'VirtualBox', 'Xen', 'Other']
        };

        const operatingSystems = {
            desktop: ['Windows 11', 'Windows 10', 'Windows 8.1', 'Windows 7', 'macOS Sonoma', 'macOS Ventura', 'macOS Monterey', 'macOS Big Sur', 'Ubuntu', 'Fedora', 'Debian', 'Linux Mint', 'Arch Linux', 'Pop!_OS', 'Chrome OS', 'Other'],
            laptop: ['Windows 11', 'Windows 10', 'Windows 8.1', 'Windows 7', 'macOS Sonoma', 'macOS Ventura', 'macOS Monterey', 'macOS Big Sur', 'Ubuntu', 'Fedora', 'Debian', 'Linux Mint', 'Arch Linux', 'Pop!_OS', 'Chrome OS', 'Other'],
            cellphone: ['iOS 17', 'iOS 16', 'iOS 15', 'Android 14', 'Android 13', 'Android 12', 'Android 11', 'Android 10', 'Other'],
            tablet: ['iPadOS 17', 'iPadOS 16', 'iPadOS 15', 'Android 14', 'Android 13', 'Android 12', 'Windows 11', 'Windows 10', 'Fire OS', 'Chrome OS', 'Other'],
            otherendpoint: ['Windows', 'macOS', 'Linux', 'Android', 'iOS', 'Embedded', 'Proprietary', 'Other'],
            server: ['Windows Server 2022', 'Windows Server 2019', 'Windows Server 2016', 'Windows Server 2012 R2', 'Ubuntu Server 24.04', 'Ubuntu Server 22.04', 'Ubuntu Server 20.04', 'RHEL 9', 'RHEL 8', 'CentOS Stream 9', 'Rocky Linux 9', 'AlmaLinux 9', 'Debian 12', 'Debian 11', 'SUSE Linux Enterprise', 'VMware ESXi', 'Proxmox VE', 'Other'],
            vm: ['Windows Server 2022', 'Windows Server 2019', 'Windows Server 2016', 'Windows 11', 'Windows 10', 'Ubuntu Server 24.04', 'Ubuntu Server 22.04', 'Ubuntu 24.04', 'Ubuntu 22.04', 'RHEL 9', 'RHEL 8', 'CentOS Stream 9', 'Rocky Linux 9', 'AlmaLinux 9', 'Debian 12', 'Debian 11', 'Other Linux', 'Other']
        };

        const canvasArea = document.getElementById('canvasArea');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const canvasGrid = document.getElementById('canvasGrid');
        const canvas = document.getElementById('canvas');
        const svg = document.getElementById('connections');
        const connHint = document.getElementById('connHint');

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function updateNetworkInfoBox() {
            document.getElementById('infoDnsProvider').textContent = state.config.dnsProvider;
            document.getElementById('infoDnsPrimary').textContent = state.config.dnsPrimary;
            document.getElementById('infoDnsSecondary').textContent = state.config.dnsSecondary;
            document.getElementById('infoDhcp').textContent = state.config.dhcpType;
            document.getElementById('infoVlans').innerHTML = state.vlans.length > 0 
                ? state.vlans.map(v => '<span class="vlan-tag">VLAN ' + v.id + ' - ' + v.subnet + '</span>').join('')
                : '<span style="color:var(--text-muted);font-size:0.6rem;">None configured</span>';
            document.getElementById('infoSSIDs').innerHTML = state.ssids.length > 0 
                ? state.ssids.map(s => '<span class="vlan-tag">' + s.name + '</span>').join('')
                : '<span style="color:var(--text-muted);font-size:0.6rem;">None configured</span>';
        }

        // Pan and zoom state
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let draggingDevice = null;
        let dragStart = { x: 0, y: 0 };
        let deviceStart = { x: 0, y: 0 };
        
        // Drag connection state
        let isDraggingConnection = false;
        let dragConnStart = { device: null, pos: null, x: 0, y: 0 };
        let dragConnCurrent = { x: 0, y: 0 };
        
        // Zone drag and resize state
        let draggingZone = null;
        let zoneStart = { x: 0, y: 0 };
        let resizingZone = null;
        let resizeStart = { x: 0, y: 0, w: 0, h: 0 };
        
        // Grid snapping
        const GRID_SIZE = 20; // Match the background grid size
        let snapToGrid = true;
        
        function snapToGridValue(value) {
            if (!snapToGrid) return value;
            return Math.round(value / GRID_SIZE) * GRID_SIZE;
        }

        function applyTransform() {
            const transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
            canvasWrapper.style.transform = transform;
            canvasGrid.style.transform = transform;
            document.getElementById('zoomLevel').textContent = Math.round(state.zoom * 100) + '%';
        }

        function resetView() {
            state.zoom = 1;
            state.panX = 0;
            state.panY = 0;
            applyTransform();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Device drag from palette
            document.querySelectorAll('.device-item:not(.zone-item)').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('type', item.dataset.type);
                    e.dataTransfer.setData('itemType', 'device');
                });
            });
            
            // Zone drag from palette
            document.querySelectorAll('.zone-item').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('zone', item.dataset.zone);
                    e.dataTransfer.setData('itemType', 'zone');
                });
            });
            
            canvasArea.addEventListener('dragover', e => e.preventDefault());
            canvasArea.addEventListener('drop', function(e) {
                e.preventDefault();
                const itemType = e.dataTransfer.getData('itemType');
                const rect = canvasArea.getBoundingClientRect();
                const rawX = (e.clientX - rect.left - state.panX) / state.zoom + 4000 - 60;
                const rawY = (e.clientY - rect.top - state.panY) / state.zoom + 4000 - 40;
                const x = snapToGridValue(rawX);
                const y = snapToGridValue(rawY);
                
                if (itemType === 'zone') {
                    const zoneType = e.dataTransfer.getData('zone');
                    if (zoneType) {
                        createZone(zoneType, x, y);
                    }
                } else {
                    const type = e.dataTransfer.getData('type');
                    if (type) {
                        createDevice(type, x, y);
                    }
                }
            });

            // Pan functionality - mousedown on canvas area
            canvasArea.addEventListener('mousedown', function(e) {
                // Only start panning if clicking on empty space (not on a device or zone)
                if (e.target === canvasArea || e.target === canvasGrid || e.target.closest('#canvasWrapper') && !e.target.closest('.network-device') && !e.target.closest('.network-zone')) {
                    isPanning = true;
                    panStart.x = e.clientX - state.panX;
                    panStart.y = e.clientY - state.panY;
                    canvasArea.classList.add('panning');
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isPanning) {
                    state.panX = e.clientX - panStart.x;
                    state.panY = e.clientY - panStart.y;
                    applyTransform();
                }
                if (draggingDevice) {
                    const dx = (e.clientX - dragStart.x) / state.zoom;
                    const dy = (e.clientY - dragStart.y) / state.zoom;
                    draggingDevice.x = snapToGridValue(deviceStart.x + dx);
                    draggingDevice.y = snapToGridValue(deviceStart.y + dy);
                    const el = document.getElementById(draggingDevice.id);
                    el.style.left = draggingDevice.x + 'px';
                    el.style.top = draggingDevice.y + 'px';
                    drawConnections();
                }
                if (draggingZone) {
                    const dx = (e.clientX - dragStart.x) / state.zoom;
                    const dy = (e.clientY - dragStart.y) / state.zoom;
                    draggingZone.x = snapToGridValue(zoneStart.x + dx);
                    draggingZone.y = snapToGridValue(zoneStart.y + dy);
                    const el = document.getElementById(draggingZone.id);
                    el.style.left = draggingZone.x + 'px';
                    el.style.top = draggingZone.y + 'px';
                }
                if (resizingZone) {
                    const dx = (e.clientX - resizeStart.x) / state.zoom;
                    const dy = (e.clientY - resizeStart.y) / state.zoom;
                    resizingZone.width = Math.max(150, snapToGridValue(resizeStart.w + dx));
                    resizingZone.height = Math.max(100, snapToGridValue(resizeStart.h + dy));
                    const el = document.getElementById(resizingZone.id);
                    el.style.width = resizingZone.width + 'px';
                    el.style.height = resizingZone.height + 'px';
                }
                if (isDraggingConnection) {
                    const rect = canvasArea.getBoundingClientRect();
                    // Convert screen coords to canvas coords
                    dragConnCurrent.x = (e.clientX - rect.left - state.panX) / state.zoom + 4000;
                    dragConnCurrent.y = (e.clientY - rect.top - state.panY) / state.zoom + 4000;
                    drawConnectionsWithDrag();
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isPanning) {
                    isPanning = false;
                    canvasArea.classList.remove('panning');
                }
                if (draggingDevice) {
                    draggingDevice = null;
                    canvasArea.classList.remove('dragging-device');
                }
                if (draggingZone) {
                    draggingZone = null;
                }
                if (resizingZone) {
                    resizingZone = null;
                }
                if (isDraggingConnection) {
                    // Check if we're over a device (or its connection point)
                    const targetDevice = findDeviceAtPoint(e.clientX, e.clientY);
                    
                    if (targetDevice && targetDevice.device.id !== dragConnStart.device.id) {
                        // Create connection
                        const exists = state.connections.some(c =>
                            (c.from === dragConnStart.device.id && c.to === targetDevice.device.id) ||
                            (c.from === targetDevice.device.id && c.to === dragConnStart.device.id)
                        );
                        if (!exists) {
                            state.connections.push({
                                id: 'conn' + Date.now(),
                                from: dragConnStart.device.id, 
                                fromPos: dragConnStart.pos,
                                to: targetDevice.device.id, 
                                toPos: targetDevice.pos,
                                type: state.connType
                            });
                            updateCounts();
                        }
                    }
                    
                    // Cleanup
                    const el = document.getElementById(dragConnStart.device.id);
                    if (el) el.classList.remove('connecting');
                    isDraggingConnection = false;
                    dragConnStart = { device: null, pos: null, x: 0, y: 0 };
                    connHint.classList.remove('active');
                    connHint.textContent = 'Click another connection point to complete';
                    drawConnections();
                }
            });

            // Scroll to zoom
            canvasArea.addEventListener('wheel', function(e) {
                e.preventDefault();
                const rect = canvasArea.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const oldZoom = state.zoom;
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                state.zoom = Math.max(0.25, Math.min(3, state.zoom + delta));
                
                // Adjust pan to zoom toward mouse position
                const zoomRatio = state.zoom / oldZoom;
                state.panX = mouseX - (mouseX - state.panX) * zoomRatio;
                state.panY = mouseY - (mouseY - state.panY) * zoomRatio;
                
                applyTransform();
            }, { passive: false });

            // Buttons
            document.getElementById('zoomInBtn').onclick = () => { state.zoom = Math.min(3, state.zoom + 0.1); applyTransform(); };
            document.getElementById('zoomOutBtn').onclick = () => { state.zoom = Math.max(0.25, state.zoom - 0.1); applyTransform(); };
            document.getElementById('resetBtn').onclick = resetView;
            document.getElementById('snapBtn').onclick = () => {
                snapToGrid = !snapToGrid;
                document.getElementById('snapBtn').innerHTML = '&#x1F9F2; Snap: ' + (snapToGrid ? 'On' : 'Off');
                document.getElementById('snapBtn').style.opacity = snapToGrid ? '1' : '0.6';
            };
            document.getElementById('wiredBtn').onclick = () => setConnType('wired');
            document.getElementById('wirelessBtn').onclick = () => setConnType('wireless');
            document.getElementById('clearBtn').onclick = clearAll;
            document.getElementById('exportPdfBtn').onclick = () => openModal('exportModal');
            document.getElementById('exportJsonBtn').onclick = exportJson;
            document.getElementById('importBtn').onclick = importData;
            document.getElementById('deleteBtn').onclick = deleteSelected;
            document.getElementById('addVMBtn').onclick = () => openModal('vmModal');

            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.onclick = () => setStatus(btn.dataset.status);
            });

            document.getElementById('propName').oninput = e => updateDeviceProp('name', e.target.value);
            document.getElementById('propIP').oninput = e => updateDeviceProp('ip', e.target.value);
            document.getElementById('propMAC').oninput = e => updateDeviceProp('mac', e.target.value);
            document.getElementById('propVLAN').onchange = e => updateDeviceProp('vlan', e.target.value);
            document.getElementById('propNotes').oninput = e => updateDeviceProp('notes', e.target.value);
            document.getElementById('propManufacturer').onchange = e => updateDeviceProp('manufacturer', e.target.value);
            document.getElementById('propOS').onchange = e => updateDeviceProp('os', e.target.value);

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') { cancelConnect(); deselectAll(); }
                if (e.key === 'Delete') {
                    if (state.selected) deleteSelected();
                    if (state.selectedZone) deleteSelectedZone();
                }
            });

            updateVlanSelect();
            updateNetworkInfoBox();
            applyTransform();
        });

        function setConnType(type) {
            state.connType = type;
            document.getElementById('wiredBtn').className = 'wired' + (type === 'wired' ? ' active' : '');
            document.getElementById('wirelessBtn').className = 'wireless' + (type === 'wireless' ? ' active' : '');
        }

        function createDevice(type, x, y) {
            state.counter++;
            const cfg = types[type];
            const device = {
                id: 'dev' + Date.now(),
                type: type,
                name: cfg.name + ' ' + state.counter,
                ip: '', mac: '', status: 'online', vlan: '', notes: '',
                manufacturer: '', os: '',
                x: x, y: y,
                vms: type === 'vmhost' ? [] : null
            };
            state.devices.push(device);
            renderDevice(device);
            updateCounts();
            document.getElementById('emptyState').style.display = 'none';
        }

        function renderDevice(d) {
            const cfg = types[d.type];
            const el = document.createElement('div');
            el.id = d.id;
            el.className = 'network-device' + (d.type === 'vmhost' ? ' vm-host' : '');
            el.style.left = d.x + 'px';
            el.style.top = d.y + 'px';
            
            const iconClass = d.type === 'vmhost' ? 'device-icon vmhost-icon' : 'device-icon';
            const iconContent = d.type === 'vmhost' ? '' : cfg.icon;
            
            el.innerHTML = '<div class="device-status status-' + d.status + '"></div>' +
                '<div class="' + iconClass + '">' + iconContent + '</div>' +
                '<div class="device-name">' + d.name + '</div>' +
                '<div class="device-ip">' + (d.ip || 'No IP') + '</div>' +
                '<div class="device-badge">' + cfg.name + '</div>' +
                (d.type === 'vmhost' ? '<div class="vm-list" id="vms' + d.id + '"></div>' : '') +
                '<div class="conn-point top" data-pos="top"></div>' +
                '<div class="conn-point bottom" data-pos="bottom"></div>' +
                '<div class="conn-point left" data-pos="left"></div>' +
                '<div class="conn-point right" data-pos="right"></div>';

            el.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('conn-point')) return;
                e.stopPropagation();
                draggingDevice = d;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                deviceStart.x = d.x;
                deviceStart.y = d.y;
                canvasArea.classList.add('dragging-device');
            });
            
            el.addEventListener('click', function(e) {
                if (e.target.classList.contains('conn-point')) return;
                e.stopPropagation();
                selectDevice(d);
            });
            
            el.querySelectorAll('.conn-point').forEach(point => {
                point.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    // Only handle click if we're not ending a drag
                    if (!isDraggingConnection) {
                        handleConnectionClick(d, point.dataset.pos);
                    }
                });
                
                // Drag-to-connect: mousedown on connection point
                point.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const connPoint = getConnectionPoint(d.id, point.dataset.pos);
                    isDraggingConnection = true;
                    dragConnStart = { 
                        device: d, 
                        pos: point.dataset.pos, 
                        x: connPoint.x, 
                        y: connPoint.y 
                    };
                    dragConnCurrent = { x: connPoint.x, y: connPoint.y };
                    
                    document.getElementById(d.id).classList.add('connecting');
                    connHint.textContent = 'Drag to another device to connect, or release to cancel';
                    connHint.classList.add('active');
                    
                    drawConnectionsWithDrag();
                });
            });

            canvas.appendChild(el);
            if (d.type === 'vmhost' && d.vms) renderVMsOnDevice(d);
        }

        function renderVMsOnDevice(d) {
            const container = document.getElementById('vms' + d.id);
            if (!container) return;
            container.innerHTML = d.vms.map(vm => '<div class="hosted-vm"><div class="dot status-' + vm.status + '"></div>' + vm.name + '</div>').join('');
        }

        // Zone functions
        function createZone(type, x, y) {
            state.zoneCounter++;
            const cfg = zoneTypes[type];
            const zone = {
                id: 'zone' + Date.now(),
                type: type,
                name: cfg.name + ' ' + state.zoneCounter,
                x: x, y: y,
                width: 200, height: 150,
                notes: ''
            };
            // Type-specific properties
            if (type === 'ups') {
                zone.manufacturer = '';
                zone.model = '';
                zone.capacity = '';
                zone.runtime = '';
                zone.ip = '';
            } else if (type === 'mdf' || type === 'idf') {
                zone.location = '';
                if (type === 'idf') zone.connectedMDF = '';
            } else if (type === 'cloud') {
                zone.provider = '';
                zone.region = '';
            } else if (type === 'onprem') {
                zone.location = '';
            }
            state.zones.push(zone);
            renderZone(zone);
            updateCounts();
            document.getElementById('emptyState').style.display = 'none';
        }

        function renderZone(z) {
            const cfg = zoneTypes[z.type];
            const el = document.createElement('div');
            el.id = z.id;
            el.className = 'network-zone zone-' + z.type;
            el.style.left = z.x + 'px';
            el.style.top = z.y + 'px';
            el.style.width = z.width + 'px';
            el.style.height = z.height + 'px';
            
            el.innerHTML = '<div class="zone-header">' +
                '<span class="zone-icon">' + cfg.icon + '</span>' +
                '<span class="zone-name">' + z.name + '</span>' +
                '<span class="zone-badge">' + cfg.name + '</span>' +
                '</div>' +
                '<div class="zone-resize"></div>';
            
            // Zone header drag
            const header = el.querySelector('.zone-header');
            header.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                draggingZone = z;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                zoneStart.x = z.x;
                zoneStart.y = z.y;
            });
            
            // Zone click to select
            el.addEventListener('click', function(e) {
                if (e.target.classList.contains('zone-resize')) return;
                e.stopPropagation();
                selectZone(z);
            });
            
            // Resize handle
            const resizeHandle = el.querySelector('.zone-resize');
            resizeHandle.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                resizingZone = z;
                resizeStart.x = e.clientX;
                resizeStart.y = e.clientY;
                resizeStart.w = z.width;
                resizeStart.h = z.height;
            });
            
            canvas.appendChild(el);
        }

        function selectZone(z) {
            deselectAll();
            state.selectedZone = z;
            document.getElementById(z.id).classList.add('selected');
            showZoneProps(z);
        }

        function showZoneProps(z) {
            document.getElementById('noSelect').style.display = 'none';
            document.getElementById('deviceProps').style.display = 'none';
            document.getElementById('zoneProps').style.display = 'block';
            
            document.getElementById('propZoneName').value = z.name;
            document.getElementById('propZoneNotes').value = z.notes || '';
            
            // Hide all type-specific sections
            document.getElementById('upsPropsSection').style.display = 'none';
            document.getElementById('mdfPropsSection').style.display = 'none';
            document.getElementById('idfPropsSection').style.display = 'none';
            document.getElementById('cloudPropsSection').style.display = 'none';
            document.getElementById('onpremPropsSection').style.display = 'none';
            
            // Show appropriate section based on zone type
            if (z.type === 'ups') {
                document.getElementById('upsPropsSection').style.display = 'block';
                document.getElementById('propUPSMfg').value = z.manufacturer || '';
                document.getElementById('propUPSModel').value = z.model || '';
                document.getElementById('propUPSCapacity').value = z.capacity || '';
                document.getElementById('propUPSRuntime').value = z.runtime || '';
                document.getElementById('propUPSIP').value = z.ip || '';
            } else if (z.type === 'mdf') {
                document.getElementById('mdfPropsSection').style.display = 'block';
                document.getElementById('propMDFLocation').value = z.location || '';
            } else if (z.type === 'idf') {
                document.getElementById('idfPropsSection').style.display = 'block';
                document.getElementById('propIDFLocation').value = z.location || '';
                // Populate MDF dropdown
                const mdfSelect = document.getElementById('propIDFMDF');
                const mdfZones = state.zones.filter(zone => zone.type === 'mdf');
                mdfSelect.innerHTML = '<option value="">-- Select MDF --</option>' + 
                    mdfZones.map(m => '<option value="' + m.id + '"' + (z.connectedMDF === m.id ? ' selected' : '') + '>' + m.name + '</option>').join('');
            } else if (z.type === 'cloud') {
                document.getElementById('cloudPropsSection').style.display = 'block';
                document.getElementById('propCloudProvider').value = z.provider || '';
                document.getElementById('propCloudRegion').value = z.region || '';
            } else if (z.type === 'onprem') {
                document.getElementById('onpremPropsSection').style.display = 'block';
                document.getElementById('propOnPremLocation').value = z.location || '';
            }
        }

        function updateZoneProp(key, value) {
            if (!state.selectedZone) return;
            state.selectedZone[key] = value;
            const el = document.getElementById(state.selectedZone.id);
            if (key === 'name') el.querySelector('.zone-name').textContent = value;
        }

        function deleteSelectedZone() {
            if (!state.selectedZone) return;
            const id = state.selectedZone.id;
            state.zones = state.zones.filter(z => z.id !== id);
            document.getElementById(id).remove();
            deselectAll();
            updateCounts();
            if (state.devices.length === 0 && state.zones.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function handleConnectionClick(device, position) {
            if (state.connecting === null) {
                state.connecting = { device: device, pos: position };
                document.getElementById(device.id).classList.add('connecting');
                connHint.classList.add('active');
            } else {
                if (state.connecting.device.id !== device.id) {
                    const exists = state.connections.some(c =>
                        (c.from === state.connecting.device.id && c.to === device.id) ||
                        (c.from === device.id && c.to === state.connecting.device.id)
                    );
                    if (!exists) {
                        state.connections.push({
                            id: 'conn' + Date.now(),
                            from: state.connecting.device.id, fromPos: state.connecting.pos,
                            to: device.id, toPos: position, type: state.connType
                        });
                        drawConnections();
                        updateCounts();
                    }
                }
                cancelConnect();
            }
        }

        function cancelConnect() {
            if (state.connecting) {
                const el = document.getElementById(state.connecting.device.id);
                if (el) el.classList.remove('connecting');
            }
            state.connecting = null;
            connHint.classList.remove('active');
        }

        function getConnectionPoint(deviceId, position) {
            const device = state.devices.find(d => d.id === deviceId);
            if (!device) return { x: 0, y: 0 };
            const el = document.getElementById(deviceId);
            if (!el) return { x: 0, y: 0 };
            const width = el.offsetWidth;
            const height = el.offsetHeight;
            const centerX = device.x + width / 2;
            const centerY = device.y + height / 2;
            switch (position) {
                case 'top': return { x: centerX, y: device.y };
                case 'bottom': return { x: centerX, y: device.y + height };
                case 'left': return { x: device.x, y: centerY };
                case 'right': return { x: device.x + width, y: centerY };
                default: return { x: centerX, y: centerY };
            }
        }

        function drawConnections() {
            let paths = '';
            state.connections.forEach(conn => {
                const from = getConnectionPoint(conn.from, conn.fromPos);
                const to = getConnectionPoint(conn.to, conn.toPos);
                const midX = (from.x + to.x) / 2;
                const midY = (from.y + to.y) / 2;
                let path;
                if (conn.fromPos === 'top' || conn.fromPos === 'bottom') {
                    path = 'M' + from.x + ',' + from.y + ' C' + from.x + ',' + midY + ' ' + to.x + ',' + midY + ' ' + to.x + ',' + to.y;
                } else {
                    path = 'M' + from.x + ',' + from.y + ' C' + midX + ',' + from.y + ' ' + midX + ',' + to.y + ' ' + to.x + ',' + to.y;
                }
                paths += '<path class="conn-' + conn.type + '" d="' + path + '"/>';
            });
            svg.innerHTML = paths;
        }
        
        function drawConnectionsWithDrag() {
            let paths = '';
            // Draw existing connections
            state.connections.forEach(conn => {
                const from = getConnectionPoint(conn.from, conn.fromPos);
                const to = getConnectionPoint(conn.to, conn.toPos);
                const midX = (from.x + to.x) / 2;
                const midY = (from.y + to.y) / 2;
                let path;
                if (conn.fromPos === 'top' || conn.fromPos === 'bottom') {
                    path = 'M' + from.x + ',' + from.y + ' C' + from.x + ',' + midY + ' ' + to.x + ',' + midY + ' ' + to.x + ',' + to.y;
                } else {
                    path = 'M' + from.x + ',' + from.y + ' C' + midX + ',' + from.y + ' ' + midX + ',' + to.y + ' ' + to.x + ',' + to.y;
                }
                paths += '<path class="conn-' + conn.type + '" d="' + path + '"/>';
            });
            
            // Draw the dragging connection line
            if (isDraggingConnection && dragConnStart.device) {
                const from = dragConnStart;
                const to = dragConnCurrent;
                const midX = (from.x + to.x) / 2;
                const midY = (from.y + to.y) / 2;
                let path;
                if (from.pos === 'top' || from.pos === 'bottom') {
                    path = 'M' + from.x + ',' + from.y + ' C' + from.x + ',' + midY + ' ' + to.x + ',' + midY + ' ' + to.x + ',' + to.y;
                } else {
                    path = 'M' + from.x + ',' + from.y + ' C' + midX + ',' + from.y + ' ' + midX + ',' + to.y + ' ' + to.x + ',' + to.y;
                }
                const strokeColor = state.connType === 'wired' ? '#0F71F0' : '#c084fc';
                paths += '<path d="' + path + '" stroke="' + strokeColor + '" stroke-width="2" fill="none" stroke-dasharray="5,5" opacity="0.7"/>';
            }
            
            svg.innerHTML = paths;
        }
        
        function findDeviceAtPoint(clientX, clientY) {
            // Find which device (if any) is under the mouse cursor
            const elements = document.elementsFromPoint(clientX, clientY);
            
            for (const el of elements) {
                // Check if it's a connection point
                if (el.classList.contains('conn-point')) {
                    const deviceEl = el.closest('.network-device');
                    if (deviceEl) {
                        const device = state.devices.find(d => d.id === deviceEl.id);
                        if (device) {
                            return { device: device, pos: el.dataset.pos };
                        }
                    }
                }
                // Check if it's a device
                if (el.classList.contains('network-device')) {
                    const device = state.devices.find(d => d.id === el.id);
                    if (device) {
                        // Determine nearest connection point
                        const rect = el.getBoundingClientRect();
                        const relX = clientX - rect.left;
                        const relY = clientY - rect.top;
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;
                        
                        // Determine which edge is closest
                        const distTop = relY;
                        const distBottom = rect.height - relY;
                        const distLeft = relX;
                        const distRight = rect.width - relX;
                        const minDist = Math.min(distTop, distBottom, distLeft, distRight);
                        
                        let pos = 'right';
                        if (minDist === distTop) pos = 'top';
                        else if (minDist === distBottom) pos = 'bottom';
                        else if (minDist === distLeft) pos = 'left';
                        
                        return { device: device, pos: pos };
                    }
                }
            }
            return null;
        }
        function selectDevice(d) {
            deselectAll();
            state.selected = d;
            document.getElementById(d.id).classList.add('selected');
            showProps(d);
        }

        function deselectAll() {
            if (state.selected) {
                const el = document.getElementById(state.selected.id);
                if (el) el.classList.remove('selected');
            }
            state.selected = null;
            if (state.selectedZone) {
                const el = document.getElementById(state.selectedZone.id);
                if (el) el.classList.remove('selected');
            }
            state.selectedZone = null;
            document.getElementById('noSelect').style.display = 'block';
            document.getElementById('deviceProps').style.display = 'none';
            document.getElementById('zoneProps').style.display = 'none';
        }

        function showProps(d) {
            document.getElementById('noSelect').style.display = 'none';
            document.getElementById('deviceProps').style.display = 'block';
            document.getElementById('propNotes').value = d.notes;
            
            // Handle device name / ISP label for router
            const nameGroup = document.getElementById('nameGroup');
            const nameLabel = document.getElementById('nameLabel');
            if (d.type === 'router') {
                nameLabel.textContent = 'ISP';
                nameGroup.style.display = 'block';
            } else {
                nameLabel.textContent = 'Device Name';
                nameGroup.style.display = 'block';
            }
            document.getElementById('propName').value = d.name;
            
            // Handle IP/MAC fields - hide for router
            const ipGroup = document.getElementById('ipGroup');
            const macGroup = document.getElementById('macGroup');
            if (d.type === 'router') {
                ipGroup.style.display = 'none';
                macGroup.style.display = 'none';
            } else {
                ipGroup.style.display = 'block';
                macGroup.style.display = 'block';
                document.getElementById('propIP').value = d.ip;
                document.getElementById('propMAC').value = d.mac;
            }
            
            // Handle status buttons - hide for router
            const statusGroup = document.getElementById('statusGroup');
            if (d.type === 'router') {
                statusGroup.style.display = 'none';
            } else {
                statusGroup.style.display = 'block';
                document.querySelectorAll('.status-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.status === d.status));
            }
            
            // Handle Router section (connection type, speeds)
            const routerSection = document.getElementById('routerSection');
            if (d.type === 'router') {
                routerSection.style.display = 'block';
                document.getElementById('propFiber').checked = d.connectionType === 'fiber';
                document.getElementById('propCoax').checked = d.connectionType === 'coax';
                document.getElementById('propDownload').value = d.downloadSpeed || '';
                document.getElementById('propUpload').value = d.uploadSpeed || '';
            } else {
                routerSection.style.display = 'none';
            }
            
            document.getElementById('vmSection').style.display = d.type === 'vmhost' ? 'block' : 'none';
            if (d.type === 'vmhost') renderVMList(d);
            
            // Handle VLAN dropdown - hide for AP, Firewall, Switch, Cloud, On-Prem, Storage, Router
            const vlanGroup = document.getElementById('vlanGroup');
            const hideVlanTypes = ['ap', 'firewall', 'switch', 'cloud', 'onprem', 'storage', 'router'];
            if (hideVlanTypes.includes(d.type)) {
                vlanGroup.style.display = 'none';
            } else {
                vlanGroup.style.display = 'block';
                document.getElementById('propVLAN').value = d.vlan;
            }
            
            // Handle Network Equipment section (Manufacturer/Model for firewall, switch, ap)
            const networkEquipSection = document.getElementById('networkEquipSection');
            const networkEquipTypes = ['firewall', 'switch', 'ap'];
            if (networkEquipTypes.includes(d.type)) {
                networkEquipSection.style.display = 'block';
                document.getElementById('propNetEquipMfg').value = d.manufacturer || '';
                document.getElementById('propNetEquipModel').value = d.model || '';
            } else {
                networkEquipSection.style.display = 'none';
            }
            
            // Handle SSID section for Access Points
            const ssidSection = document.getElementById('ssidSection');
            if (d.type === 'ap') {
                ssidSection.style.display = 'block';
                renderAPSSIDList(d);
            } else {
                ssidSection.style.display = 'none';
            }
            
            // Handle Switch section
            const switchSection = document.getElementById('switchSection');
            if (d.type === 'switch') {
                switchSection.style.display = 'block';
                document.getElementById('propSwitchPorts').value = d.ports || '';
                document.getElementById('propPOE').checked = d.poe || false;
                renderSwitchVLANList(d);
            } else {
                switchSection.style.display = 'none';
            }
            
            // Handle Firewall section
            const firewallSection = document.getElementById('firewallSection');
            if (d.type === 'firewall') {
                firewallSection.style.display = 'block';
                document.getElementById('propFirewallPorts').value = d.ports || '';
            } else {
                firewallSection.style.display = 'none';
            }
            
            // Handle Printer section
            const printerSection = document.getElementById('printerSection');
            if (d.type === 'printer') {
                printerSection.style.display = 'block';
                document.getElementById('propPrinterModel').value = d.model || '';
            } else {
                printerSection.style.display = 'none';
            }
            
            // Handle manufacturer dropdown - hide for network equipment types (they have text input now)
            const mfgGroup = document.getElementById('manufacturerGroup');
            const mfgSelect = document.getElementById('propManufacturer');
            if (manufacturers[d.type] && !networkEquipTypes.includes(d.type)) {
                mfgGroup.style.display = 'block';
                mfgSelect.innerHTML = '<option value="">-- Select --</option>' + 
                    manufacturers[d.type].map(m => '<option value="' + m + '"' + (d.manufacturer === m ? ' selected' : '') + '>' + m + '</option>').join('');
            } else {
                mfgGroup.style.display = 'none';
            }
            
            // Handle OS dropdown
            const osGroup = document.getElementById('osGroup');
            const osSelect = document.getElementById('propOS');
            if (operatingSystems[d.type]) {
                osGroup.style.display = 'block';
                osSelect.innerHTML = '<option value="">-- Select --</option>' + 
                    operatingSystems[d.type].map(o => '<option value="' + o + '"' + (d.os === o ? ' selected' : '') + '>' + o + '</option>').join('');
            } else {
                osGroup.style.display = 'none';
            }
        }
        
        function renderSwitchVLANList(d) {
            const container = document.getElementById('switchVLANList');
            if (state.vlans.length === 0) {
                container.innerHTML = '<p style="font-size:10px;color:var(--text-muted);text-align:center;">No VLANs configured. Add VLANs in Config.</p>';
                return;
            }
            
            // Initialize vlans array on device if not present
            if (!d.assignedVlans) d.assignedVlans = [];
            
            container.innerHTML = state.vlans.map(vlan => {
                const isChecked = d.assignedVlans.includes(vlan.id);
                return '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.75rem;color:var(--text-secondary);padding:4px 0;">' +
                    '<input type="checkbox" ' + (isChecked ? 'checked' : '') + ' onchange="toggleSwitchVLAN(' + vlan.id + ')" style="width:14px;height:14px;accent-color:var(--primary);">' +
                    '<span style="flex:1">VLAN ' + vlan.id + ' - ' + vlan.name + '</span>' +
                    '<span style="font-size:0.65rem;color:var(--text-muted);">' + vlan.subnet + '</span>' +
                '</label>';
            }).join('');
        }
        
        function toggleSwitchVLAN(vlanId) {
            if (!state.selected || state.selected.type !== 'switch') return;
            if (!state.selected.assignedVlans) state.selected.assignedVlans = [];
            
            const index = state.selected.assignedVlans.indexOf(vlanId);
            if (index === -1) {
                state.selected.assignedVlans.push(vlanId);
            } else {
                state.selected.assignedVlans.splice(index, 1);
            }
        }
        
        function renderAPSSIDList(d) {
            const container = document.getElementById('apSSIDList');
            if (state.ssids.length === 0) {
                container.innerHTML = '<p style="font-size:10px;color:var(--text-muted);text-align:center;">No SSIDs configured. Add SSIDs in Config.</p>';
                return;
            }
            
            // Initialize ssids array on device if not present
            if (!d.ssids) d.ssids = [];
            
            container.innerHTML = state.ssids.map(ssid => {
                const isChecked = d.ssids.includes(ssid.name);
                const vlanInfo = ssid.vlan ? ' (VLAN ' + ssid.vlan + ')' : '';
                return '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.75rem;color:var(--text-secondary);padding:4px 0;">' +
                    '<input type="checkbox" ' + (isChecked ? 'checked' : '') + ' onchange="toggleAPSSID(\'' + ssid.name + '\')" style="width:14px;height:14px;accent-color:var(--primary);">' +
                    '<span style="flex:1">' + ssid.name + '</span>' +
                    '<span style="font-size:0.65rem;color:var(--text-muted);">' + ssid.security + vlanInfo + '</span>' +
                '</label>';
            }).join('');
        }
        
        function toggleAPSSID(ssidName) {
            if (!state.selected || state.selected.type !== 'ap') return;
            if (!state.selected.ssids) state.selected.ssids = [];
            
            const index = state.selected.ssids.indexOf(ssidName);
            if (index === -1) {
                state.selected.ssids.push(ssidName);
            } else {
                state.selected.ssids.splice(index, 1);
            }
        }

        function renderVMList(d) {
            const list = document.getElementById('vmList');
            list.innerHTML = (!d.vms || d.vms.length === 0) 
                ? '<p style="font-size:10px;color:var(--text-muted);text-align:center;">No VMs</p>'
                : d.vms.map((vm, i) => '<div class="vlan-item"><div class="dot status-' + vm.status + '" style="width:8px;height:8px;border-radius:50%;"></div><span style="flex:1">' + vm.name + '</span><button class="vlan-del" onclick="removeVM(' + i + ')">&times;</button></div>').join('');
        }

        function removeVM(index) {
            if (state.selected && state.selected.vms) {
                state.selected.vms.splice(index, 1);
                renderVMsOnDevice(state.selected);
                renderVMList(state.selected);
            }
        }

        function updateDeviceProp(key, value) {
            if (!state.selected) return;
            state.selected[key] = value;
            const el = document.getElementById(state.selected.id);
            if (key === 'name') el.querySelector('.device-name').textContent = value;
            if (key === 'ip') el.querySelector('.device-ip').textContent = value || 'No IP';
        }

        function setStatus(status) {
            if (!state.selected) return;
            state.selected.status = status;
            document.getElementById(state.selected.id).querySelector('.device-status').className = 'device-status status-' + status;
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.status === status));
        }

        function deleteSelected() {
            if (!state.selected) return;
            const id = state.selected.id;
            state.connections = state.connections.filter(c => c.from !== id && c.to !== id);
            state.devices = state.devices.filter(d => d.id !== id);
            document.getElementById(id).remove();
            deselectAll();
            drawConnections();
            updateCounts();
            if (state.devices.length === 0 && state.zones.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function updateCounts() {
            document.getElementById('deviceCount').textContent = state.devices.length + ' device' + (state.devices.length !== 1 ? 's' : '');
            document.getElementById('zoneCount').textContent = state.zones.length + ' zone' + (state.zones.length !== 1 ? 's' : '');
            document.getElementById('connCount').textContent = state.connections.length + ' connection' + (state.connections.length !== 1 ? 's' : '');
        }

        function updateVlanSelect() {
            document.getElementById('propVLAN').innerHTML = '<option value="">Select VLAN</option>' + 
                state.vlans.map(v => '<option value="' + v.id + '">VLAN ' + v.id + ' - ' + v.name + '</option>').join('');
        }
        
        function updateSSIDVlanSelect() {
            document.getElementById('newSSIDVlan').innerHTML = '<option value="">No VLAN</option>' + 
                state.vlans.map(v => '<option value="' + v.id + '">VLAN ' + v.id + ' - ' + v.name + '</option>').join('');
        }

        function openConfig() {
            openModal('configModal');
            document.getElementById('dnsProvider').value = state.config.dnsProvider;
            document.getElementById('dnsPrimary').value = state.config.dnsPrimary;
            document.getElementById('dnsSecondary').value = state.config.dnsSecondary;
            document.getElementById('dhcpType').value = state.config.dhcpType;
            renderVlanList();
            renderSSIDList();
            updateDnsFields();
            updateDhcpDevices();
            updateSSIDVlanSelect();
        }

        function renderVlanList() {
            document.getElementById('vlanList').innerHTML = state.vlans.map((v, i) => 
                '<div class="vlan-item"><span class="vlan-id">VLAN ' + v.id + '</span><span class="vlan-name">' + v.name + '</span><span class="vlan-subnet">' + v.subnet + '</span><button class="vlan-del" onclick="deleteVlan(' + i + ')">&times;</button></div>'
            ).join('');
        }
        
        function renderSSIDList() {
            const container = document.getElementById('ssidList');
            if (state.ssids.length === 0) {
                container.innerHTML = '<p style="font-size:0.7rem;color:var(--text-muted);text-align:center;padding:10px;">No SSIDs configured</p>';
                return;
            }
            container.innerHTML = state.ssids.map((s, i) => {
                const vlanInfo = s.vlan ? 'VLAN ' + s.vlan : 'No VLAN';
                return '<div class="vlan-item"><span class="vlan-id" style="min-width:auto;"></span><span class="vlan-name" style="flex:1;">' + s.name + '</span><span class="vlan-subnet" style="font-size:0.6rem;">' + s.security + ' / ' + vlanInfo + '</span><button class="vlan-del" onclick="deleteSSID(' + i + ')">&times;</button></div>';
            }).join('');
        }
        
        function deleteSSID(index) {
            const ssidName = state.ssids[index].name;
            state.ssids.splice(index, 1);
            // Remove this SSID from all access points
            state.devices.forEach(d => {
                if (d.type === 'ap' && d.ssids) {
                    d.ssids = d.ssids.filter(s => s !== ssidName);
                }
            });
            renderSSIDList();
        }
        
        function saveSSID() {
            const name = document.getElementById('newSSIDName').value.trim();
            const security = document.getElementById('newSSIDSecurity').value;
            const vlan = document.getElementById('newSSIDVlan').value;
            
            if (name) {
                // Check for duplicate
                if (state.ssids.some(s => s.name === name)) {
                    alert('An SSID with this name already exists.');
                    return;
                }
                state.ssids.push({ name, security, vlan });
                renderSSIDList();
                closeModal('ssidModal');
                document.getElementById('newSSIDName').value = '';
                document.getElementById('newSSIDSecurity').value = 'WPA2-Personal';
                document.getElementById('newSSIDVlan').value = '';
            }
        }

        function deleteVlan(index) {
            state.vlans.splice(index, 1);
            renderVlanList();
            updateVlanSelect();
            updateNetworkInfoBox();
        }

        function saveVlan() {
            const id = parseInt(document.getElementById('newVlanID').value);
            const name = document.getElementById('newVlanName').value;
            const subnet = document.getElementById('newVlanSubnet').value;
            const gateway = document.getElementById('newVlanGateway').value;
            if (id && name && subnet) {
                state.vlans.push({ id, name, subnet, gateway });
                renderVlanList();
                updateVlanSelect();
                updateNetworkInfoBox();
                closeModal('vlanModal');
                document.getElementById('newVlanID').value = '';
                document.getElementById('newVlanName').value = '';
                document.getElementById('newVlanSubnet').value = '';
                document.getElementById('newVlanGateway').value = '';
            }
        }

        function updateDnsFields() {
            const prov = document.getElementById('dnsProvider').value;
            document.getElementById('dnsServerGroup').style.display = prov === 'Server Hosted' ? 'block' : 'none';
            if (prov === 'Server Hosted') {
                document.getElementById('dnsServerDevice').innerHTML = '<option value="">Select...</option>' +
                    state.devices.filter(d => d.type === 'server').map(d => '<option value="' + d.id + '">' + d.name + '</option>').join('');
            }
        }

        function updateDhcpDevices() {
            const type = document.getElementById('dhcpType').value;
            const typeMap = { 'Router': 'router', 'Dedicated Server': 'server', 'Firewall': 'firewall' };
            const devices = state.devices.filter(d => d.type === typeMap[type]);
            document.getElementById('dhcpDevice').innerHTML = '<option value="">Select...</option>' +
                devices.map(d => '<option value="' + d.id + '">' + d.name + '</option>').join('');
        }

        function saveConfig() {
            state.config.dnsProvider = document.getElementById('dnsProvider').value;
            state.config.dnsPrimary = document.getElementById('dnsPrimary').value;
            state.config.dnsSecondary = document.getElementById('dnsSecondary').value;
            state.config.dhcpType = document.getElementById('dhcpType').value;
            state.config.dhcpDevice = document.getElementById('dhcpDevice').value;
            updateNetworkInfoBox();
            closeModal('configModal');
        }

        function saveVM() {
            if (!state.selected || state.selected.type !== 'vmhost') return;
            const name = document.getElementById('newVMName').value;
            const status = document.getElementById('newVMStatus').value;
            if (name) {
                state.selected.vms.push({ name, status });
                renderVMsOnDevice(state.selected);
                renderVMList(state.selected);
                closeModal('vmModal');
                document.getElementById('newVMName').value = '';
            }
        }

        function clearAll() {
            if (confirm('Clear all devices and connections?')) {
                state.devices = [];
                state.connections = [];
                state.counter = 0;
                document.querySelectorAll('.network-device').forEach(el => el.remove());
                svg.innerHTML = '';
                deselectAll();
                updateCounts();
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function setExportFormat(format) {
            state.exportFormat = format;
            document.getElementById('formatPdfBtn').classList.toggle('active', format === 'pdf');
            document.getElementById('formatSvgBtn').classList.toggle('active', format === 'svg');
            document.getElementById('orientationGroup').style.display = format === 'pdf' ? 'block' : 'none';
            document.getElementById('exportBtn').textContent = format === 'pdf' ? 'Export PDF' : 'Export SVG';
        }

        function doExport() {
            if (state.exportFormat === 'svg') {
                generateSVG();
            } else {
                generatePDF();
            }
        }

        function getVlanName(vlanId) {
            const vlan = state.vlans.find(v => v.id === vlanId);
            return vlan ? `VLAN ${vlan.id} - ${vlan.name}` : 'None';
        }

        function generateSVG() {
            const title = document.getElementById('pdfTitle').value || 'Network Diagram';
            const client = document.getElementById('pdfClient').value || '';
            const includeInventory = document.getElementById('includeInventory').checked;
            closeModal('exportModal');
            
            if (state.devices.length === 0) {
                alert('No devices to export. Add some devices first.');
                return;
            }
            
            // Calculate bounding box
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            state.devices.forEach(d => {
                const el = document.getElementById(d.id);
                const w = el ? el.offsetWidth : 120;
                const h = el ? el.offsetHeight : 100;
                minX = Math.min(minX, d.x);
                minY = Math.min(minY, d.y);
                maxX = Math.max(maxX, d.x + w);
                maxY = Math.max(maxY, d.y + h);
            });
            
            const padding = 50;
            minX -= padding;
            minY -= padding;
            maxX += padding;
            maxY += padding;
            
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;
            
            // Build inventory data
            let inventoryHeight = 0;
            let inventoryContent = '';
            if (includeInventory && state.devices.length > 0) {
                inventoryHeight = 60 + (state.devices.length * 22);
                inventoryContent = `
                    <rect x="0" y="${contentHeight + 20}" width="${Math.max(contentWidth, 900)}" height="${inventoryHeight}" fill="#0a0a0a" stroke="#333" rx="10"/>
                    <text x="15" y="${contentHeight + 45}" fill="#ff3b3b" font-size="14" font-weight="bold" font-family="Arial, sans-serif">Device Inventory</text>
                    <text x="15" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">Name</text>
                    <text x="130" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">Manufacturer</text>
                    <text x="230" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">OS</text>
                    <text x="350" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">IP Address</text>
                    <text x="470" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">MAC Address</text>
                    <text x="610" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">VLAN</text>
                    <text x="720" y="${contentHeight + 65}" fill="#888" font-size="10" font-family="Arial, sans-serif">Notes</text>
                `;
                state.devices.forEach((d, i) => {
                    const y = contentHeight + 85 + (i * 22);
                    const cfg = types[d.type];
                    inventoryContent += `
                        <text x="15" y="${y}" fill="#e4e4e7" font-size="11" font-family="Arial, sans-serif">${cfg.icon} ${d.name.substring(0, 12)}</text>
                        <text x="130" y="${y}" fill="#a1a1a1" font-size="11" font-family="Arial, sans-serif">${(d.manufacturer || '-').substring(0, 12)}</text>
                        <text x="230" y="${y}" fill="#a1a1a1" font-size="11" font-family="Arial, sans-serif">${(d.os || '-').substring(0, 15)}</text>
                        <text x="350" y="${y}" fill="#a1a1a1" font-size="11" font-family="monospace">${d.ip || '-'}</text>
                        <text x="470" y="${y}" fill="#a1a1a1" font-size="11" font-family="monospace">${d.mac || '-'}</text>
                        <text x="610" y="${y}" fill="#a1a1a1" font-size="11" font-family="Arial, sans-serif">${getVlanName(d.vlan).substring(0, 12)}</text>
                        <text x="720" y="${y}" fill="#888" font-size="11" font-family="Arial, sans-serif">${(d.notes || '-').substring(0, 25)}${d.notes && d.notes.length > 25 ? '...' : ''}</text>
                    `;
                });
            }
            
            const totalHeight = contentHeight + (includeInventory ? inventoryHeight + 40 : 0);
            
            // Build SVG
            let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${contentWidth}" height="${totalHeight + 60}" viewBox="0 0 ${contentWidth} ${totalHeight + 60}">
    <defs>
        <style>
            .title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: #e4e4e7; }
            .subtitle { font-family: Arial, sans-serif; font-size: 12px; fill: #a1a1a1; }
            .device-box { fill: #0a0a0a; stroke: #333; stroke-width: 2; rx: 10; }
            .device-name { font-family: Arial, sans-serif; font-size: 11px; fill: #e4e4e7; font-weight: 600; }
            .device-ip { font-family: monospace; font-size: 10px; fill: #666; }
            .device-badge { font-family: Arial, sans-serif; font-size: 9px; fill: #ff6b6b; }
            .device-icon { font-size: 20px; }
            .conn-wired { stroke: #ff3b3b; stroke-width: 2; fill: none; }
            .conn-wireless { stroke: #c084fc; stroke-width: 2; fill: none; stroke-dasharray: 8,4; }
        </style>
    </defs>
    <rect width="100%" height="100%" fill="#050505"/>
    <text x="15" y="25" class="title">${title}</text>
    ${client ? `<text x="15" y="45" class="subtitle">Client: ${client}</text>` : ''}
    <text x="${contentWidth - 15}" y="25" class="subtitle" text-anchor="end">${new Date().toLocaleDateString()}</text>
    <g transform="translate(0, 60)">`;
            
            // Add connections
            state.connections.forEach(conn => {
                const from = getConnectionPoint(conn.from, conn.fromPos);
                const to = getConnectionPoint(conn.to, conn.toPos);
                const fx = from.x - minX, fy = from.y - minY;
                const tx = to.x - minX, ty = to.y - minY;
                const midX = (fx + tx) / 2, midY = (fy + ty) / 2;
                let path;
                if (conn.fromPos === 'top' || conn.fromPos === 'bottom') {
                    path = `M${fx},${fy} C${fx},${midY} ${tx},${midY} ${tx},${ty}`;
                } else {
                    path = `M${fx},${fy} C${midX},${fy} ${midX},${ty} ${tx},${ty}`;
                }
                svgContent += `<path d="${path}" class="conn-${conn.type}"/>`;
            });
            
            // Add devices
            state.devices.forEach(d => {
                const cfg = types[d.type];
                const x = d.x - minX;
                const y = d.y - minY;
                const statusColors = { online: '#22c55e', offline: '#555', warning: '#f97316', retired: '#555', decommissioned: '#555' };
                
                let iconContent;
                if (d.type === 'vmhost') {
                    iconContent = `
                        <text x="52" y="32" text-anchor="middle" font-size="14"></text>
                        <text x="68" y="32" text-anchor="middle" font-size="14"></text>`;
                } else {
                    iconContent = `<text x="60" y="30" text-anchor="middle" class="device-icon">${cfg.icon}</text>`;
                }
                
                svgContent += `
                    <g transform="translate(${x}, ${y})">
                        <rect class="device-box" width="120" height="90"/>
                        <circle cx="105" cy="12" r="4" fill="${statusColors[d.status] || '#555'}"/>
                        ${iconContent}
                        <text x="60" y="50" text-anchor="middle" class="device-name">${d.name}</text>
                        <text x="60" y="65" text-anchor="middle" class="device-ip">${d.ip || 'No IP'}</text>
                        <text x="60" y="82" text-anchor="middle" class="device-badge">${cfg.name}</text>
                    </g>`;
            });
            
            svgContent += inventoryContent;
            svgContent += `
    </g>
    <text x="15" y="${totalHeight + 55}" fill="#666" font-size="10" font-family="Arial, sans-serif">Generated by NetMap Pro</text>
</svg>`;
            
            // Download SVG
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = title.toLowerCase().replace(/\s+/g, '-') + '-' + new Date().toISOString().split('T')[0] + '.svg';
            a.click();
        }

        function generatePDF() {
            const title = document.getElementById('pdfTitle').value || 'Network Diagram';
            const client = document.getElementById('clientName').value || '';
            const site = document.getElementById('siteName').value || '';
            const orientation = document.getElementById('pdfOrientation').value;
            const includeInventory = document.getElementById('includeInventory').checked;
            closeModal('exportModal');
            
            if (state.devices.length === 0 && state.zones.length === 0) {
                alert('No devices or zones to export. Add some first.');
                return;
            }
            
            // Calculate bounding box of all devices and zones
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            state.devices.forEach(d => {
                const el = document.getElementById(d.id);
                const w = el ? el.offsetWidth : 120;
                const h = el ? el.offsetHeight : 100;
                minX = Math.min(minX, d.x);
                minY = Math.min(minY, d.y);
                maxX = Math.max(maxX, d.x + w);
                maxY = Math.max(maxY, d.y + h);
            });
            state.zones.forEach(z => {
                minX = Math.min(minX, z.x);
                minY = Math.min(minY, z.y);
                maxX = Math.max(maxX, z.x + z.width);
                maxY = Math.max(maxY, z.y + z.height);
            });
            
            // Add padding around the content
            const padding = 50;
            minX -= padding;
            minY -= padding;
            maxX += padding;
            maxY += padding;
            
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;
            
            // Include network info box dimensions
            const infoBox = document.getElementById('networkInfoBox');
            const infoBoxWidth = infoBox.offsetWidth + 40;
            const infoBoxHeight = infoBox.offsetHeight + 40;
            
            // Create a temporary container for rendering
            const tempContainer = document.createElement('div');
            tempContainer.style.cssText = `
                position: fixed; left: -10000px; top: 0;
                background: #050505; padding: 20px;
            `;
            document.body.appendChild(tempContainer);
            
            // Create SVG for connections
            const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            tempSvg.setAttribute('width', contentWidth);
            tempSvg.setAttribute('height', contentHeight);
            tempSvg.style.cssText = 'position: absolute; top: 0; left: 0; pointer-events: none;';
            
            // Draw connections offset to bounding box
            let paths = '';
            state.connections.forEach(conn => {
                const from = getConnectionPoint(conn.from, conn.fromPos);
                const to = getConnectionPoint(conn.to, conn.toPos);
                const fx = from.x - minX, fy = from.y - minY;
                const tx = to.x - minX, ty = to.y - minY;
                const midX = (fx + tx) / 2, midY = (fy + ty) / 2;
                let path;
                if (conn.fromPos === 'top' || conn.fromPos === 'bottom') {
                    path = `M${fx},${fy} C${fx},${midY} ${tx},${midY} ${tx},${ty}`;
                } else {
                    path = `M${fx},${fy} C${midX},${fy} ${midX},${ty} ${tx},${ty}`;
                }
                const strokeColor = conn.type === 'wired' ? '#0F71F0' : '#c084fc';
                const dashArray = conn.type === 'wireless' ? 'stroke-dasharray="8,4"' : '';
                paths += `<path d="${path}" stroke="${strokeColor}" stroke-width="2" fill="none" ${dashArray}/>`;
            });
            tempSvg.innerHTML = paths;
            
            // Create wrapper
            const wrapper = document.createElement('div');
            wrapper.style.cssText = `position: relative; width: ${contentWidth + infoBoxWidth}px; height: ${Math.max(contentHeight, infoBoxHeight)}px; background: #ffffff;`;
            
            // Diagram area
            const diagramArea = document.createElement('div');
            diagramArea.style.cssText = `position: relative; width: ${contentWidth}px; height: ${contentHeight}px; display: inline-block; vertical-align: top;`;
            diagramArea.appendChild(tempSvg);
            
            // Clone and position zones (render first so they appear behind devices)
            state.zones.forEach(z => {
                const orig = document.getElementById(z.id);
                if (orig) {
                    const clone = orig.cloneNode(true);
                    clone.style.left = (z.x - minX) + 'px';
                    clone.style.top = (z.y - minY) + 'px';
                    clone.style.width = z.width + 'px';
                    clone.style.height = z.height + 'px';
                    clone.classList.remove('selected');
                    // Hide resize handle
                    const resizeHandle = clone.querySelector('.zone-resize');
                    if (resizeHandle) resizeHandle.style.display = 'none';
                    diagramArea.appendChild(clone);
                }
            });
            
            // Clone and position devices
            state.devices.forEach(d => {
                const orig = document.getElementById(d.id);
                const clone = orig.cloneNode(true);
                clone.style.left = (d.x - minX) + 'px';
                clone.style.top = (d.y - minY) + 'px';
                clone.classList.remove('selected', 'connecting');
                clone.querySelectorAll('.conn-point').forEach(cp => cp.style.display = 'none');
                diagramArea.appendChild(clone);
            });
            
            wrapper.appendChild(diagramArea);
            
            // Clone network info box
            const infoClone = infoBox.cloneNode(true);
            infoClone.style.cssText = `
                position: absolute; top: 0; right: 0;
                background: #ffffff; border: 1px solid #e0e0e0; border-radius: 10px;
                padding: 14px; min-width: 220px; font-size: 11px; color: #1a1a1a;
            `;
            wrapper.appendChild(infoClone);
            
            tempContainer.appendChild(wrapper);
            
            // Render to canvas
            html2canvas(wrapper, { 
                backgroundColor: '#ffffff', 
                scale: 2, 
                useCORS: true, 
                logging: false 
            }).then(canvasImg => {
                document.body.removeChild(tempContainer);
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation, unit: 'mm', format: 'a4' });
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                // Header - client/site on left, "Network Diagram" centered
                pdf.setFillColor(0, 30, 98);
                pdf.rect(0, 0, pageWidth, 16, 'F');
                
                // Client and site on left
                const headerLeft = [client, site].filter(Boolean).join(' - ');
                if (headerLeft) {
                    pdf.setTextColor(234, 234, 234);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(headerLeft, 10, 10);
                }
                
                // "Network Diagram" centered
                pdf.setTextColor(234, 234, 234);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Network Diagram', pageWidth / 2, 10, { align: 'center' });
                
                // Date on right
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.text(new Date().toLocaleDateString(), pageWidth - 10, 10, { align: 'right' });
                
                // Calculate image dimensions to fit and center
                const imgData = canvasImg.toDataURL('image/png');
                const availableWidth = pageWidth - 20;
                const availableHeight = pageHeight - 36;
                
                const imgAspect = canvasImg.width / canvasImg.height;
                const availAspect = availableWidth / availableHeight;
                
                let finalWidth, finalHeight;
                if (imgAspect > availAspect) {
                    finalWidth = availableWidth;
                    finalHeight = availableWidth / imgAspect;
                } else {
                    finalHeight = availableHeight;
                    finalWidth = availableHeight * imgAspect;
                }
                
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = 20 + (availableHeight - finalHeight) / 2;
                
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);
                
                // Footer for page 1
                pdf.setFontSize(8);
                pdf.setTextColor(102, 102, 102);
                pdf.text('Generated by i-Tech Network Mapping Tool', 10, pageHeight - 5);
                pdf.text(includeInventory ? 'Page 1 of 2+' : 'Page 1 of 1', pageWidth - 10, pageHeight - 5, { align: 'right' });
                
                // Add device inventory pages if checked
                if (includeInventory && state.devices.length > 0) {
                    // Group devices by type
                    const devicesByType = {};
                    state.devices.forEach(d => {
                        if (!devicesByType[d.type]) devicesByType[d.type] = [];
                        devicesByType[d.type].push(d);
                    });
                    
                    let pageNum = 2;
                    
                    pdf.addPage();
                    
                    // Header for inventory page - client on left, "Device List" centered
                    pdf.setFillColor(0, 30, 98);
                    pdf.rect(0, 0, pageWidth, 16, 'F');
                    
                    if (client) {
                        pdf.setTextColor(234, 234, 234);
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(client, 10, 10);
                    }
                    
                    pdf.setTextColor(234, 234, 234);
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Device List', pageWidth / 2, 10, { align: 'center' });
                    
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(new Date().toLocaleDateString(), pageWidth - 10, 10, { align: 'right' });
                    
                    let yPos = 24;
                    
                    // Define columns per device type
                    const typeConfigs = {
                        'switch': {
                            cols: ['Name', 'Manufacturer', 'Model', 'IP Address', 'Ports', 'PoE', 'VLANs', 'Notes'],
                            widths: orientation === 'landscape' ? [30, 28, 30, 35, 15, 15, 50, 67] : [22, 20, 22, 28, 12, 12, 40, 34],
                            getData: (d) => [
                                d.name, d.manufacturer || '-', d.model || '-', d.ip || '-',
                                d.ports || '-', d.poe ? 'Yes' : 'No',
                                d.assignedVlans ? d.assignedVlans.map(v => 'VLAN ' + v).join(', ') : '-',
                                d.notes || '-'
                            ]
                        },
                        'firewall': {
                            cols: ['Name', 'Manufacturer', 'Model', 'IP Address', 'MAC Address', 'Ports', 'Notes'],
                            widths: orientation === 'landscape' ? [35, 30, 35, 38, 42, 18, 72] : [24, 22, 24, 30, 35, 14, 41],
                            getData: (d) => [d.name, d.manufacturer || '-', d.model || '-', d.ip || '-', d.mac || '-', d.ports || '-', d.notes || '-']
                        },
                        'ap': {
                            cols: ['Name', 'Manufacturer', 'Model', 'IP Address', 'MAC Address', 'SSIDs', 'Notes'],
                            widths: orientation === 'landscape' ? [35, 30, 35, 38, 42, 50, 40] : [24, 22, 24, 30, 35, 35, 20],
                            getData: (d) => [
                                d.name, d.manufacturer || '-', d.model || '-', d.ip || '-', d.mac || '-',
                                d.ssids ? d.ssids.join(', ') : '-', d.notes || '-'
                            ]
                        },
                        'router': {
                            cols: ['ISP', 'Connection', 'Download', 'Upload', 'Notes'],
                            widths: orientation === 'landscape' ? [50, 30, 40, 40, 110] : [35, 25, 35, 35, 60],
                            getData: (d) => [
                                d.name, d.connectionType || '-', 
                                d.downloadSpeed ? d.downloadSpeed + ' Mbps' : '-',
                                d.uploadSpeed ? d.uploadSpeed + ' Mbps' : '-',
                                d.notes || '-'
                            ]
                        },
                        'printer': {
                            cols: ['Name', 'Manufacturer', 'Model', 'IP Address', 'MAC Address', 'VLAN', 'Notes'],
                            widths: orientation === 'landscape' ? [35, 30, 35, 35, 40, 35, 60] : [24, 22, 25, 30, 35, 28, 26],
                            getData: (d) => [d.name, d.manufacturer || '-', d.model || '-', d.ip || '-', d.mac || '-', getVlanName(d.vlan), d.notes || '-']
                        },
                        'server': {
                            cols: ['Name', 'Manufacturer', 'OS', 'IP Address', 'MAC Address', 'VLAN', 'Notes'],
                            widths: orientation === 'landscape' ? [35, 30, 35, 35, 40, 35, 60] : [24, 22, 25, 30, 35, 28, 26],
                            getData: (d) => [d.name, d.manufacturer || '-', d.os || '-', d.ip || '-', d.mac || '-', getVlanName(d.vlan), d.notes || '-']
                        },
                        'vmhost': {
                            cols: ['Name', 'Manufacturer', 'OS', 'IP Address', 'MAC Address', 'VMs', 'Notes'],
                            widths: orientation === 'landscape' ? [35, 30, 35, 35, 40, 50, 45] : [24, 22, 25, 30, 35, 35, 19],
                            getData: (d) => [
                                d.name, d.manufacturer || '-', d.os || '-', d.ip || '-', d.mac || '-',
                                d.vms ? d.vms.map(vm => vm.name).join(', ') : '-', d.notes || '-'
                            ]
                        },
                        'default': {
                            cols: ['Name', 'Manufacturer', 'OS', 'IP Address', 'MAC Address', 'VLAN', 'Notes'],
                            widths: orientation === 'landscape' ? [35, 30, 35, 35, 40, 35, 60] : [24, 22, 25, 30, 35, 28, 26],
                            getData: (d) => [d.name, d.manufacturer || '-', d.os || '-', d.ip || '-', d.mac || '-', getVlanName(d.vlan), d.notes || '-']
                        }
                    };
                    
                    // Type display names
                    const typeNames = {
                        'desktop': 'Desktops', 'laptop': 'Laptops', 'cellphone': 'Cell Phones', 'tablet': 'Tablets',
                        'printer': 'Printers', 'otherendpoint': 'Other Endpoints', 'server': 'Servers', 'nas': 'NAS Devices',
                        'router': 'Internet Connection', 'firewall': 'Firewalls', 'switch': 'Switches', 'ap': 'Access Points',
                        'vmhost': 'VM Hosts', 'vm': 'Virtual Machines', 'storage': 'Storage', 'phone': 'Desk Phones', 
                        'camera': 'Security Cameras', 'iot': 'IoT Devices'
                    };
                    
                    // Helper function to draw page header
                    function drawPageHeader(pageTitle) {
                        pdf.setFillColor(0, 30, 98);
                        pdf.rect(0, 0, pageWidth, 16, 'F');
                        const headerLeft = [client, site].filter(Boolean).join(' - ');
                        if (headerLeft) {
                            pdf.setTextColor(234, 234, 234);
                            pdf.setFontSize(10);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text(headerLeft, 10, 10);
                        }
                        pdf.setTextColor(234, 234, 234);
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(pageTitle, pageWidth / 2, 10, { align: 'center' });
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(new Date().toLocaleDateString(), pageWidth - 10, 10, { align: 'right' });
                    }
                    
                    // Process each device type
                    Object.keys(devicesByType).forEach(deviceType => {
                        const devices = devicesByType[deviceType];
                        const config = typeConfigs[deviceType] || typeConfigs['default'];
                        const typeName = typeNames[deviceType] || types[deviceType]?.name || deviceType;
                        
                        // Check if we need a new page
                        if (yPos > pageHeight - 40) {
                            pdf.addPage();
                            pageNum++;
                            drawPageHeader('Device List');
                            yPos = 24;
                        }
                        
                        // Section header
                        pdf.setFillColor(15, 113, 240);
                        pdf.rect(10, yPos - 4, pageWidth - 20, 8, 'F');
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(255, 255, 255);
                        pdf.text(typeName + ' (' + devices.length + ')', 12, yPos + 1);
                        yPos += 10;
                        
                        // Column headers
                        pdf.setFillColor(240, 240, 240);
                        pdf.rect(10, yPos - 4, pageWidth - 20, 7, 'F');
                        pdf.setFontSize(6);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(60, 60, 60);
                        
                        let xOffset = 10;
                        config.cols.forEach((col, i) => {
                            pdf.text(col, xOffset + 1, yPos);
                            xOffset += config.widths[i];
                        });
                        yPos += 6;
                        
                        // Device rows
                        pdf.setFont('helvetica', 'normal');
                        devices.forEach((d, i) => {
                            // Check for page break
                            if (yPos > pageHeight - 15) {
                                pdf.addPage();
                                pageNum++;
                                drawPageHeader('Device List');
                                yPos = 24;
                                
                                // Repeat column headers
                                pdf.setFillColor(240, 240, 240);
                                pdf.rect(10, yPos - 4, pageWidth - 20, 7, 'F');
                                pdf.setFontSize(6);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setTextColor(60, 60, 60);
                                let xOff = 10;
                                config.cols.forEach((col, j) => {
                                    pdf.text(col, xOff + 1, yPos);
                                    xOff += config.widths[j];
                                });
                                yPos += 6;
                                pdf.setFont('helvetica', 'normal');
                            }
                            
                            // Alternate row background
                            if (i % 2 === 0) {
                                pdf.setFillColor(250, 250, 250);
                            } else {
                                pdf.setFillColor(255, 255, 255);
                            }
                            pdf.rect(10, yPos - 4, pageWidth - 20, 6, 'F');
                            
                            const rowData = config.getData(d);
                            pdf.setFontSize(6);
                            pdf.setTextColor(40, 40, 40);
                            
                            let xOff = 10;
                            rowData.forEach((val, j) => {
                                const maxChars = Math.floor(config.widths[j] / 1.8);
                                const truncated = String(val).substring(0, maxChars);
                                pdf.text(truncated, xOff + 1, yPos);
                                xOff += config.widths[j];
                            });
                            
                            yPos += 6;
                        });
                        
                        yPos += 6; // Space between sections
                    });
                    
                    // Add Zone Inventory if there are zones
                    if (state.zones.length > 0) {
                        // Check if we need a new page
                        if (yPos > pageHeight - 60) {
                            pdf.addPage();
                            pageNum++;
                            drawPageHeader('Zone Inventory');
                            yPos = 24;
                        }
                        
                        // Zone section header
                        pdf.setFillColor(15, 113, 240);
                        pdf.rect(10, yPos - 4, pageWidth - 20, 8, 'F');
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(255, 255, 255);
                        pdf.text('Infrastructure Zones (' + state.zones.length + ')', 12, yPos + 1);
                        yPos += 10;
                        
                        // Group zones by type
                        const zonesByType = {};
                        state.zones.forEach(z => {
                            if (!zonesByType[z.type]) zonesByType[z.type] = [];
                            zonesByType[z.type].push(z);
                        });
                        
                        const zoneTypeNames = {
                            'cloud': 'Cloud Zones',
                            'onprem': 'On-Premises Zones',
                            'mdf': 'MDF (Main Distribution Frame)',
                            'idf': 'IDF (Intermediate Distribution Frame)',
                            'ups': 'UPS Coverage'
                        };
                        
                        Object.keys(zonesByType).forEach(zoneType => {
                            const zones = zonesByType[zoneType];
                            const typeName = zoneTypeNames[zoneType] || zoneType;
                            
                            // Check for page break
                            if (yPos > pageHeight - 30) {
                                pdf.addPage();
                                pageNum++;
                                drawPageHeader('Zone Inventory');
                                yPos = 24;
                            }
                            
                            // Sub-section header
                            pdf.setFillColor(240, 240, 240);
                            pdf.rect(10, yPos - 4, pageWidth - 20, 7, 'F');
                            pdf.setFontSize(7);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(60, 60, 60);
                            pdf.text(typeName, 12, yPos);
                            yPos += 7;
                            
                            zones.forEach((z, i) => {
                                if (yPos > pageHeight - 15) {
                                    pdf.addPage();
                                    pageNum++;
                                    drawPageHeader('Zone Inventory');
                                    yPos = 24;
                                }
                                
                                // Alternate row background
                                if (i % 2 === 0) {
                                    pdf.setFillColor(250, 250, 250);
                                } else {
                                    pdf.setFillColor(255, 255, 255);
                                }
                                pdf.rect(10, yPos - 4, pageWidth - 20, 6, 'F');
                                
                                pdf.setFontSize(6);
                                pdf.setFont('helvetica', 'normal');
                                pdf.setTextColor(40, 40, 40);
                                
                                let details = z.name;
                                if (zoneType === 'ups') {
                                    const parts = [];
                                    if (z.manufacturer) parts.push(z.manufacturer);
                                    if (z.model) parts.push(z.model);
                                    if (z.capacity) parts.push(z.capacity + ' VA');
                                    if (z.runtime) parts.push(z.runtime + ' min runtime');
                                    if (z.ip) parts.push('IP: ' + z.ip);
                                    if (parts.length > 0) details += ' - ' + parts.join(', ');
                                } else if (zoneType === 'cloud') {
                                    const parts = [];
                                    if (z.provider) parts.push(z.provider);
                                    if (z.region) parts.push(z.region);
                                    if (parts.length > 0) details += ' - ' + parts.join(', ');
                                } else if (zoneType === 'mdf' || zoneType === 'idf' || zoneType === 'onprem') {
                                    if (z.location) details += ' - ' + z.location;
                                    if (zoneType === 'idf' && z.connectedMDF) {
                                        const mdf = state.zones.find(zone => zone.id === z.connectedMDF);
                                        if (mdf) details += ' (Connected to: ' + mdf.name + ')';
                                    }
                                }
                                if (z.notes) details += ' | Notes: ' + z.notes;
                                
                                pdf.text(details.substring(0, 150), 12, yPos);
                                yPos += 6;
                            });
                            
                            yPos += 4;
                        });
                    }
                    
                    // Footer for last page
                    pdf.setFontSize(8);
                    pdf.setTextColor(102, 102, 102);
                    pdf.text('Generated by i-Tech Network Mapping Tool', 10, pageHeight - 5);
                    pdf.text('Page ' + pageNum + ' of ' + pageNum, pageWidth - 10, pageHeight - 5, { align: 'right' });
                }
                
                pdf.save(title.toLowerCase().replace(/\s+/g, '-') + '-' + new Date().toISOString().split('T')[0] + '.pdf');
            });
        }

        function exportJson() {
            const data = { 
                devices: state.devices, 
                connections: state.connections, 
                zones: state.zones,
                vlans: state.vlans,
                ssids: state.ssids,
                config: state.config,
                clientName: document.getElementById('clientName').value || '',
                siteName: document.getElementById('siteName').value || '',
                view: { zoom: state.zoom, panX: state.panX, panY: state.panY }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'network-project-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = evt => {
                        try {
                            const data = JSON.parse(evt.target.result);
                            state.devices = data.devices || [];
                            state.connections = data.connections || [];
                            state.vlans = data.vlans || state.vlans;
                            state.ssids = data.ssids || [];
                            state.config = data.config || state.config;
                            if (data.clientName) {
                                document.getElementById('clientName').value = data.clientName;
                            }
                            if (data.siteName) {
                                document.getElementById('siteName').value = data.siteName;
                            }
                            if (data.view) {
                                state.zoom = data.view.zoom || 1;
                                state.panX = data.view.panX || 0;
                                state.panY = data.view.panY || 0;
                            }
                            document.querySelectorAll('.network-device').forEach(el => el.remove());
                            document.querySelectorAll('.network-zone').forEach(el => el.remove());
                            state.zones = data.zones || [];
                            state.devices.forEach(d => renderDevice(d));
                            state.zones.forEach(z => renderZone(z));
                            drawConnections();
                            updateVlanSelect();
                            updateNetworkInfoBox();
                            updateCounts();
                            applyTransform();
                            if (state.devices.length > 0 || state.zones.length > 0) {
                                document.getElementById('emptyState').style.display = 'none';
                            }
                        } catch (err) {
                            alert('Error loading project: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
    </script>
</body>
</html>
